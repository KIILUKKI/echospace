<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body { margin: 0; height: 100vh; font-family: Inter, sans-serif; background: #0b0f14; color: #e6edf3; display: flex; }
#app { display: flex; width: 100%; height: 100%; position: relative; }

/* HOME */
#home { position: absolute; inset: 0; display: flex; }
#homeLeft { width: 260px; background: #161b22; padding: 16px; overflow-y: auto; }
#homeCenter { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
#nickRow { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; width: 320px; }
#nick { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #161b22; color: #fff; }
#nickColor { width: 36px; height: 36px; border: none; cursor: pointer; outline: none; }

/* ROOMS */
.room { padding: 10px; border-radius: 8px; background: #161b22; margin-bottom: 8px; cursor: pointer; }
.room:hover { background: #21262d; }

/* MAIN */
#main { flex: 1; display: flex; flex-direction: column; display: none; }
#header { height: 52px; background: #161b22; display: flex; align-items: center; padding: 0 14px; border-bottom: 1px solid #0d1117; }
#header button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; margin-right: 10px; }
#roomName { font-weight: 600; }
#chatWrapper { display: flex; flex: 1; overflow: hidden; }
#chatSidebar { width: 260px; background: #161b22; border-right: 1px solid #0d1117; }
#chat { flex: 1; padding: 16px; overflow-y: auto; position: relative; }

/* MESSAGE */
.message { display: flex; gap: 10px; margin-bottom: 14px; }
.avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #000; flex-shrink: 0; }
.msg { background: #161b22; padding: 10px 14px; border-radius: 10px; width: 100%; position: relative; word-break: break-word; }
.msg b { margin-right: 6px; }
.time { font-size: 11px; color: #8b949e; margin-left: 6px; }
.reply-btn { position: absolute; right: 8px; top: 8px; font-size: 12px; color: #8b949e; cursor: pointer; opacity: 0; transition: .15s; }
.msg:hover .reply-btn { opacity: 1; }
.reply-preview { background: #0d1117; border-left: 3px solid #58a6ff; padding: 6px; font-size: 12px; margin-bottom: 6px; }

/* INPUT */
#replyBox { display: none; background: #21262d; padding: 8px 14px; font-size: 12px; }
#replyBox span { color: #58a6ff; }
#replyBox button { background: none; border: none; color: #8b949e; cursor: pointer; margin-left: 8px; }
#inputBar { padding: 14px; background: #161b22; border-top: 1px solid #0d1117; display: flex; }
#msg { flex: 1; padding: 14px; border-radius: 8px; border: none; background: #0d1117; color: #fff; }
#createRoom { width: 320px; padding: 14px; border-radius: 10px; border: none; background: #58a6ff; font-weight: 600; color: #000; cursor: pointer; }
</style>
</head>
<body>
<div id="app">

<!-- HOME -->
<div id="home">
  <div id="homeLeft">
    <div id="roomList"></div>
  </div>
  <div id="homeCenter">
    <div id="nickRow">
      <input id="nick" placeholder="Username">
      <input type="color" id="nickColor" value="#58a6ff">
    </div>
    <button id="createRoom">Create / Join Room</button>
  </div>
</div>

<!-- MAIN -->
<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName">Select room</span>
  </div>

  <div id="chatWrapper">
    <div id="chatSidebar"></div>
    <div id="chat"></div>
  </div>

  <div id="replyBox"></div>
  <div id="inputBar">
    <input id="msg" placeholder="Message... (/clear /delete /deletelast)">
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, limit, writeBatch 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId: "chat-fc8ef"
});
const db = getFirestore(app);

let room = "", nick = "", nickColor = "#58a6ff", replyTo = null;

const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const roomList = document.getElementById("roomList");
const replyBox = document.getElementById("replyBox");
const roomName = document.getElementById("roomName");

// Load stored nick and color
document.getElementById("nick").value = localStorage.getItem("nick") || "";
document.getElementById("nickColor").value = localStorage.getItem("nickColor") || "#58a6ff";
document.getElementById("nickColor").oninput = () => localStorage.setItem("nickColor", document.getElementById("nickColor").value);

// Load rooms
async function loadRooms() {
  roomList.innerHTML = "";
  const s = await getDocs(collection(db, "rooms"));
  s.forEach(r => {
    const d = document.createElement("div");
    d.className = "room";
    d.textContent = "# " + r.id;
    d.onclick = () => joinRoom(r.id);
    roomList.appendChild(d);
  });
}
loadRooms();

// Create room
document.getElementById("createRoom").onclick = async () => {
  const r = prompt("Room name"); if (!r) return;
  const p = prompt("Password (optional)") || "";
  const roomRef = doc(db, "rooms", r);
  if ((await getDoc(roomRef)).exists()) return alert("Room exists");
  await setDoc(roomRef, { password: p });
  loadRooms();
};

// Join room
async function joinRoom(r) {
  const pass = prompt("Password"); if (pass === null) return;
  nick = document.getElementById("nick").value || ("Anon" + Math.floor(Math.random() * 1000));
  nickColor = document.getElementById("nickColor").value;
  localStorage.setItem("nick", nick);
  localStorage.setItem("nickColor", nickColor);

  const roomRef = doc(db, "rooms", r);
  const snap = await getDoc(roomRef);
  if (!snap.exists()) return;
  if (snap.data().password !== pass) return alert("Wrong password");

  document.getElementById("home").style.display = "none";
  document.getElementById("main").style.display = "flex";
  room = r;
  roomName.textContent = "# " + r;

  // Listen messages
  onSnapshot(query(collection(db, "rooms", room, "messages"), orderBy("time")), snapshot => {
    chat.innerHTML = "";
    let lastMsg = null;
    snapshot.forEach(d => {
      const m = d.data();
      const t = m.time?.toDate();
      lastMsg = m;
      chat.innerHTML += `
      <div class="message">
        <div class="avatar" style="background:${m.color}">${m.name[0]}</div>
        <div class="msg">
          ${m.reply ? `<div class="reply-preview"><b>${m.reply.name}</b>: ${m.reply.text}</div>` : ""}
          <b style="color:${m.color}">${m.name}</b>
          <span class="time">${t ? t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ""}</span>
          <div>${m.text}</div>
          ${!m.reply ? `<div class="reply-btn" data-name="${m.name}" data-text="${m.text}">reply</div>` : ""}
        </div>
      </div>`;
    });
    chat.scrollTop = chat.scrollHeight;

    // Notifications
    if (lastMsg && document.hidden && lastMsg.name !== nick && Notification.permission === "granted") {
      new Notification("New message", { body: lastMsg.name + ": " + lastMsg.text });
    }
  });
}

// Reply handling
chat.addEventListener("click", e => {
  const b = e.target.closest(".reply-btn");
  if (!b) return;
  replyTo = { name: b.dataset.name, text: b.dataset.text };
  replyBox.style.display = "block";
  replyBox.innerHTML = `Replying to <span>${replyTo.name}</span><button onclick="cancelReply()">x</button>`;
});

window.cancelReply = () => {
  replyTo = null;
  replyBox.style.display = "none";
};

// Send message & commands
msg.addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;
  const text = msg.value.trim();
  msg.value = "";
  if (!text) return;

  // Commands
  if (text === "/clear") {
    const s = await getDocs(collection(db, "rooms", room, "messages"));
    const b = writeBatch(db);
    s.forEach(d => b.delete(d.ref));
    await b.commit();
    return;
  }

  if (text === "/deletelast") {
    const q = query(collection(db, "rooms", room, "messages"), orderBy("time", "desc"), limit(1));
    const s = await getDocs(q);
    const b = writeBatch(db);
    s.forEach(d => { if (d.data().name === nick) b.delete(d.ref); });
    await b.commit();
    return;
  }

  if (text === "/delete") {
    if (!confirm("Delete the entire room and all messages?")) return;
    try {
      const roomRef = doc(db, "rooms", room);
      const messagesRef = collection(db, "rooms", room, "messages");
      const b = writeBatch(db);
      const msgs = await getDocs(messagesRef);
      msgs.forEach(d => b.delete(d.ref));
      b.delete(roomRef);
      await b.commit();
      alert("Room deleted");
      location.reload();
    } catch (err) { console.error(err); alert("Failed to delete room"); }
    return;
  }

  // Normal message
  await addDoc(collection(db, "rooms", room, "messages"), { name: nick, text, reply: replyTo, color: nickColor, time: serverTimestamp() });
  replyTo = null;
  replyBox.style.display = "none";
});

// Back button
document.getElementById("back").onclick = () => location.reload();

// Request notifications
if (Notification.permission !== "granted") Notification.requestPermission();
</script>
</body>
</html>
