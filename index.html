<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;font-family:Inter,sans-serif;background:#0b0f14;color:#e6edf3}
#app{width:100%;height:100%;position:relative}

/* HOME */
#home{position:absolute;inset:0;display:flex}
#homeLeft{
  width:260px;background:#161b22;padding:14px;
  overflow-y:auto;border-right:1px solid #0d1117
}
.room{padding:10px;border-radius:8px;background:#21262d;margin-bottom:8px;cursor:pointer}
.room:hover{background:#58a6ff;color:#000}
#homeCenter{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}
#nickRow{display:flex;gap:12px;width:320px;margin-bottom:20px}
#nick{flex:1;padding:12px;border-radius:10px;border:none;background:#21262d;color:#fff}
#nickColor{width:42px;height:42px;border-radius:50%;border:none}
#createRoom{padding:14px 28px;border-radius:12px;background:#58a6ff;border:none;font-weight:600}

/* MAIN */
#main{display:none;height:100%;flex-direction:column}
#header{height:52px;background:#161b22;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid #0d1117}
#chatWrapper{display:flex;flex:1}
#chatSidebar{width:260px;background:#161b22;border-right:1px solid #0d1117}
#chatWrapperMain{flex:1;display:flex;flex-direction:column}
#chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}

.message{display:flex;gap:10px}
.avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:#000}
.msg{background:#161b22;padding:10px 14px;border-radius:10px;position:relative}
.time{font-size:11px;color:#8b949e;margin-left:6px}
.reply-btn{position:absolute;right:8px;top:8px;font-size:12px;color:#8b949e;cursor:pointer;opacity:0}
.msg:hover .reply-btn{opacity:1}
.reply-preview{background:#0d1117;border-left:3px solid #58a6ff;padding:6px;font-size:12px;margin-bottom:6px}

#replyBox{display:none;background:#21262d;padding:8px 14px;font-size:12px}
#inputBar{padding:14px;background:#161b22;border-top:1px solid #0d1117;display:flex;gap:8px;align-items:center}
#msg{flex:1;padding:12px;border-radius:8px;border:none;background:#0d1117;color:#fff}

#emojiPicker{display:none;flex-wrap:wrap;gap:4px;padding:6px;background:#21262d;border-radius:8px;position:absolute;bottom:60px;left:14px;max-width:320px;max-height:200px;overflow-y:auto}
#emojiPicker div{cursor:pointer;font-size:18px}
#emojiBtn{border:none;background:none;color:#fff;font-size:18px}

#typingIndicator{font-size:12px;color:#8b949e;padding-left:16px}
</style>
</head>

<body>
<div id="app">

<div id="home">
  <div id="homeLeft"><h2>Rooms</h2><div id="roomList"></div></div>
  <div id="homeCenter">
    <div id="nickRow">
      <input id="nick" placeholder="Username">
      <input type="color" id="nickColor" value="#58a6ff">
    </div>
    <button id="createRoom">Create / Join Room</button>
  </div>
</div>

<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName"></span>
  </div>

  <div id="chatWrapper">
    <div id="chatSidebar"></div>
    <div id="chatWrapperMain">
      <div id="chat"></div>
      <div id="typingIndicator"></div>
    </div>
  </div>

  <div id="replyBox"></div>
  <div id="inputBar">
    <button id="emojiBtn">üòä</button>
    <input id="msg" placeholder="Message... (/clear /delete)">
    <div id="emojiPicker"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, addDoc,
  getDocs, query, orderBy, onSnapshot,
  serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
});
const db = getFirestore(app);

const chat=document.getElementById("chat");
const msg=document.getElementById("msg");
const typingIndicator=document.getElementById("typingIndicator");
const nickInput=document.getElementById("nick");
const nickColorInput=document.getElementById("nickColor");
const roomList=document.getElementById("roomList");

let room="", nick="", nickColor="#58a6ff", replyTo=null;
let lastMessageTime=0;

/* Notification permission */
if(Notification.permission!=="granted"){
  Notification.requestPermission();
}

/* Typing */
let typingTimeout;
msg.addEventListener("input",()=>{
  if(!room) return;
  setDoc(doc(db,"rooms",room,"typing",nick),{time:Date.now()});
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{
    deleteDoc(doc(db,"rooms",room,"typing",nick));
  },1500);
});

/* Load rooms */
async function loadRooms(){
  roomList.innerHTML="";
  const s=await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.textContent="# "+r.id;
    d.onclick=()=>joinRoom(r.id);
    roomList.appendChild(d);
  });
}

/* Join */
async function joinRoom(r){
  const ref=doc(db,"rooms",r);
  const snap=await getDoc(ref);
  if(!snap.exists()) return;

  nick=nickInput.value||("Anon"+Math.floor(Math.random()*1000));
  nickColor=nickColorInput.value;
  room=r;

  home.style.display="none";
  main.style.display="flex";
  roomName.textContent="# "+r;

  /* Messages */
  onSnapshot(query(collection(db,"rooms",room,"messages"),orderBy("time")),s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const t=m.time?.toMillis()||0;

      if(t>lastMessageTime && document.hidden && m.name!==nick){
        new Notification("New message.");
      }
      lastMessageTime=Math.max(lastMessageTime,t);

      const el=document.createElement("div");
      el.className="message";
      el.innerHTML=`
        <div class="avatar" style="background:${m.color}">${m.name[0]}</div>
        <div class="msg">
          ${m.reply?`<div class="reply-preview"><b>${m.reply.name}</b>: ${m.reply.text}</div>`:""}
          <b style="color:${m.color}">${m.name}</b>
          <span class="time">${new Date(t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
          <div>${m.text}</div>
        </div>`;
      chat.appendChild(el);
    });
    chat.scrollTop=chat.scrollHeight;
  });

  /* Typing listener */
  onSnapshot(collection(db,"rooms",room,"typing"),s=>{
    const users=[];
    s.forEach(d=>{
      if(d.id!==nick) users.push(d.id);
    });
    typingIndicator.textContent=users.length
      ? users.join(", ")+" typing..."
      : "";
  });
}

/* Send */
msg.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const text=msg.value.trim();
  msg.value="";
  if(!text) return;

  if(text==="/clear"){
    const msgs=await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    return;
  }

  if(text==="/delete"){
    if(!confirm("Delete room?")) return;
    const msgs=await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    await deleteDoc(doc(db,"rooms",room));
    location.reload();
    return;
  }

  await addDoc(collection(db,"rooms",room,"messages"),{
    name:nick,text,reply:replyTo,color:nickColor,time:serverTimestamp()
  });
});

back.onclick=()=>location.reload();
loadRooms();
</script>
</body>
</html>
