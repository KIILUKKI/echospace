<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yksinkertainen Chat (koko koodi)</title>
<style>
  /* Perusvärit */
  :root{
    --bg:#0b0f14;
    --panel:#121417;
    --card:#1b2026;
    --accent:#58a6ff;
    --muted:#9aa0a6;
    --text:#e6edf3;
    --sidebar-w:260px;
    --guest-gray:#9aa0a6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  button{cursor:pointer}
  a{color:inherit}

  /* App layout */
  #app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

  /* Top bar */
  header.topbar{height:56px;background:var(--panel);display:flex;align-items:center;justify-content:space-between;padding:0 12px;border-bottom:1px solid #0d1117}
  .brand{font-weight:700}
  .top-actions{display:flex;gap:8px;align-items:center}
  .top-actions button{background:transparent;border:0;color:var(--text);padding:6px 10px;border-radius:8px}
  .top-actions button:hover{background:rgba(255,255,255,0.02)}

  /* Main content: sidebar + main */
  .container{flex:1;display:flex;min-height:0}

  /* Sidebar / rooms */
  #sidebar{width:var(--sidebar-w);min-width:200px;background:var(--panel);border-right:1px solid #0d1117;padding:12px;overflow:auto}
  #sidebar h3{margin:0 0 12px 0;font-size:14px}
  #roomList{display:flex;flex-direction:column;gap:8px}
  .roomItem{padding:10px;border-radius:8px;background:var(--card);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .roomItem:hover{background:var(--accent);color:#000}
  .roomItem.active{background:linear-gradient(180deg,var(--accent),#3f8fe6);color:#000;font-weight:700}

  /* Center / main chat area */
  #main{flex:1;display:flex;flex-direction:column;min-height:0}
  #mainHeader{height:56px;background:var(--panel);border-bottom:1px solid #0d1117;display:flex;align-items:center;padding:8px 12px;gap:12px}
  #chatArea{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
  .message{display:flex;gap:10px;align-items:flex-start}
  .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;background:var(--muted)}
  .msgBox{background:var(--card);padding:10px 12px;border-radius:10px;max-width:70%}
  .msgHeader{font-weight:700;font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .msgText{white-space:pre-wrap;word-break:break-word;margin-top:6px}

  /* Input area */
  #inputBar{padding:12px;background:var(--panel);border-top:1px solid #0d1117;display:flex;gap:8px;align-items:center}
  #msg{flex:1;padding:10px;border-radius:8px;border:0;background:var(--card);color:var(--text)}
  #sendBtn{padding:10px 12px;border-radius:8px;background:var(--accent);color:#000;border:0;font-weight:700}

  /* Login modal/section */
  #loginView{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.45));display:flex;align-items:center;justify-content:center;padding:20px;z-index:60}
  #loginCard{width:100%;max-width:420px;background:var(--panel);padding:20px;border-radius:12px;border:1px solid #0d1117;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  #loginCard h2{margin:0 0 12px 0}
  #loginCard input{width:100%;padding:10px;border-radius:8px;border:0;background:var(--card);color:var(--text);margin-bottom:8px}
  #loginCard .row{display:flex;gap:8px}

  /* HowTo panel */
  #howPanel{position:fixed;top:70px;right:12px;width:320px;background:var(--panel);border:1px solid #0d1117;padding:12px;border-radius:10px;display:none;z-index:80}

  /* Mobile responsiveness */
  @media (max-width:800px){
    #sidebar{display:none}
    #mobileOpenSidebar{display:block;position:fixed;left:12px;bottom:12px;background:var(--accent);border:0;padding:12px;border-radius:999px;color:#000;z-index:80}
  }
  @media (min-width:801px){
    #mobileOpenSidebar{display:none}
  }

  /* small helper */
  .muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div id="app">

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">Chat-demo</div>
    <div class="top-actions">
      <button id="howBtn" title="How To">How To</button>
      <button id="fullBtn" title="Fullscreen">⤢</button>
      <button id="settingsBtn" title="Settings">⚙️</button>
    </div>
  </header>

  <!-- Main container -->
  <div class="container">
    <!-- Sidebar (sivu valikko) -->
    <aside id="sidebar" aria-label="Rooms">
      <h3>Huoneet</h3>
      <div id="roomList"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="createRoomBtn" style="flex:1;padding:8px;border-radius:8px;border:0;background:var(--accent);color:#000">Uusi huone</button>
        <button id="joinRoomBtn" style="padding:8px;border-radius:8px;border:0;background:transparent;color:var(--text);border:1px solid #0d1117">Liity</button>
      </div>

      <div style="margin-top:18px">
        <div class="muted">Oma nimi</div>
        <input id="nick" placeholder="Nimesi" style="width:100%;padding:8px;border-radius:8px;border:0;background:var(--card);color:var(--text);margin-top:8px">
        <div style="display:flex;gap:8px;margin-top:8px">
          <input type="color" id="nickColor" value="#58a6ff" style="width:44px;height:44px;border-radius:10px;border:0;padding:0;background:none">
          <button id="logoutBtn" style="flex:1;padding:10px;border-radius:8px;border:0;background:#333;color:var(--text)">Kirjaudu ulos</button>
        </div>
      </div>
    </aside>

    <!-- Main chat area -->
    <main id="main">
      <div id="mainHeader">
        <div id="roomTitle" style="font-weight:700"># Ei huonetta</div>
        <div style="flex:1"></div>
        <div id="mainInfo" class="muted">Ei viestejä</div>
      </div>

      <div id="chatArea" role="log" aria-live="polite">
        <!-- messages appended here -->
      </div>

      <div id="inputBar">
        <input id="msg" placeholder="Kirjoita viesti ja paina Enter..." autocomplete="off">
        <button id="sendBtn">Lähetä</button>
      </div>
    </main>
  </div>

  <!-- Mobile open sidebar -->
  <button id="mobileOpenSidebar">☰</button>

  <!-- How To panel -->
  <div id="howPanel">
    <h4>How to</h4>
    <div class="muted">• Luo tai liity huoneeseen.<br>• Valitse nimi ja väri.<br>• Paina Enter lähettääksesi.</div>
    <div style="margin-top:8px;text-align:right"><button id="closeHow">Sulje</button></div>
  </div>

  <!-- Login / modal -->
  <div id="loginView" style="display:none">
    <div id="loginCard">
      <h2>Kirjaudu sisään</h2>
      <div class="muted" style="margin-bottom:10px">Voit rekisteröityä paikallisesti tai jatkaa vieraana.</div>
      <input id="loginUser" placeholder="Käyttäjänimi">
      <input id="loginPass" placeholder="Salasana" type="password">
      <div class="row" style="margin-top:8px">
        <button id="loginBtn" style="flex:1;padding:10px;border-radius:8px;border:0;background:var(--accent);color:#000">Kirjaudu / Rekisteröi</button>
        <button id="guestBtn" style="padding:10px;border-radius:8px;border:0;background:#333;color:var(--text)">Vieras</button>
      </div>
      <div style="margin-top:10px" class="muted">Huom. Tallennus tapahtuu selaimen localStorageen (demo).</div>
    </div>
  </div>

</div>

<script>
/*
  Täysi toimiva yksityinen demo:
  - Huoneet ja viestit tallennetaan localStorageen avaimella "chat_demo_rooms"
  - Käyttäjätiedot localStoragessa "chat_demo_users" (yksinkertainen demo)
  - Login piilottaa top-painikkeet (How To, Fullscreen, Settings)
  - Sidebar (sivu valikko) näkyy desktopilla aina, mobiilissa se aukeaa painikkeella
*/

/* --- Data helpers (localStorage) --- */
const STORAGE_ROOMS = 'chat_demo_rooms_v1';
const STORAGE_USERS = 'chat_demo_users_v1';
function loadRoomsFromStorage(){
  try { return JSON.parse(localStorage.getItem(STORAGE_ROOMS) || '{}'); }
  catch(e){ return {}; }
}
function saveRoomsToStorage(obj){
  localStorage.setItem(STORAGE_ROOMS, JSON.stringify(obj));
}
function loadUsersFromStorage(){
  try { return JSON.parse(localStorage.getItem(STORAGE_USERS) || '{}'); }
  catch(e){ return {}; }
}
function saveUsersToStorage(obj){
  localStorage.setItem(STORAGE_USERS, JSON.stringify(obj));
}

/* --- DOM refs --- */
const sidebar = document.getElementById('sidebar');
const roomListEl = document.getElementById('roomList');
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const nickInput = document.getElementById('nick');
const nickColor = document.getElementById('nickColor');
const logoutBtn = document.getElementById('logoutBtn');

const roomTitle = document.getElementById('roomTitle');
const mainInfo = document.getElementById('mainInfo');
const chatArea = document.getElementById('chatArea');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');

const howBtn = document.getElementById('howBtn');
const howPanel = document.getElementById('howPanel');
const closeHow = document.getElementById('closeHow');
const fullBtn = document.getElementById('fullBtn');
const settingsBtn = document.getElementById('settingsBtn');

const mobileOpen = document.getElementById('mobileOpenSidebar');

const loginView = document.getElementById('loginView');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');
const guestBtn = document.getElementById('guestBtn');

/* App state */
let rooms = loadRoomsFromStorage(); // { roomName: { messages: [{id, name, color, text, t}] } }
let users = loadUsersFromStorage(); // { username: { pass, color, joined } }
let session = localStorage.getItem('chat_demo_session') || null; // username or GuestXXXX
let currentRoom = null;

/* Initialize UI */
function init(){
  // restore nick / color
  const storedNick = localStorage.getItem('chat_demo_nick') || '';
  const storedColor = localStorage.getItem('chat_demo_color') || '#58a6ff';
  nickInput.value = storedNick;
  nickColor.value = storedColor;

  // register event listeners
  createRoomBtn.addEventListener('click', onCreateRoom);
  joinRoomBtn.addEventListener('click', onJoinRoom);
  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
  howBtn.addEventListener('click', ()=> howPanel.style.display = howPanel.style.display === 'block' ? 'none' : 'block');
  closeHow.addEventListener('click', ()=> howPanel.style.display = 'none');
  fullBtn.addEventListener('click', toggleFullScreen);
  settingsBtn.addEventListener('click', showSettings);
  mobileOpen.addEventListener('click', toggleMobileSidebar);
  logoutBtn.addEventListener('click', doLogout);

  loginBtn.addEventListener('click', onLogin);
  guestBtn.addEventListener('click', onGuest);

  // hide login if session exists
  if(session){
    showAppViews();
  } else {
    showLogin();
  }

  renderRoomList();
  updateMainInfo();
  handleResize();
  window.addEventListener('resize', handleResize);
}
init();

/* --- UI helpers --- */
function showLogin(){
  loginView.style.display = 'flex';
  // hide top buttons during login
  howBtn.style.display = 'none';
  fullBtn.style.display = 'none';
  settingsBtn.style.display = 'none';
  // hide sidebar on very small screens? We'll keep it but mobile button shows
  // disable chat area
  chatArea.innerHTML = '';
  roomTitle.textContent = '# Ei huonetta';
  currentRoom = null;
}
function showAppViews(){
  loginView.style.display = 'none';
  howPanel.style.display = 'none';
  // show top buttons
  howBtn.style.display = '';
  fullBtn.style.display = '';
  settingsBtn.style.display = '';
  // restore nick from session
  const storedNick = localStorage.getItem('chat_demo_nick') || session || '';
  nickInput.value = storedNick;
}

/* Login handlers */
function onLogin(){
  const u = (loginUser.value || '').trim();
  const p = (loginPass.value || '').trim();
  if(!u){ alert('Anna käyttäjänimi'); return; }
  users = loadUsersFromStorage();
  if(users[u]){
    // exists -> check password
    if(users[u].pass !== p){ alert('Väärä salasana'); return; }
  } else {
    // create
    users[u] = { pass: p, joined: Date.now(), color: '#58a6ff' };
    saveUsersToStorage(users);
  }
  session = u;
  localStorage.setItem('chat_demo_session', session);
  localStorage.setItem('chat_demo_nick', u);
  localStorage.setItem('chat_demo_color', users[u].color || '#58a6ff');
  showAppViews();
}

function onGuest(){
  const g = 'Guest' + Math.floor(Math.random()*9000 + 1000);
  session = g;
  localStorage.setItem('chat_demo_session', session);
  localStorage.setItem('chat_demo_nick', g);
  localStorage.setItem('chat_demo_color', getComputedStyle(document.documentElement).getPropertyValue('--guest-gray') || '#9aa0a6');
  showAppViews();
}

/* Logout/delete */
function doLogout(){
  if(confirm('Kirjaudutko ulos?')) {
    localStorage.removeItem('chat_demo_session');
    session = null;
    showLogin();
  }
}

/* Settings (simple) */
function showSettings(){
  const choice = prompt('Valitse: 1=Logout, 2=Delete account (localStorage)', '1');
  if(choice === '1'){ doLogout(); return; }
  if(choice === '2'){
    const s = localStorage.getItem('chat_demo_session');
    if(!s || s.startsWith('Guest')) { alert('Ei poistettavaa käyttäjää'); return; }
    if(!confirm('Poistetaanko paikallinen käyttäjä ja tunnukset?')) return;
    users = loadUsersFromStorage();
    delete users[s];
    saveUsersToStorage(users);
    localStorage.removeItem('chat_demo_session');
    session = null;
    showLogin();
    alert('Käyttäjä poistettu (paikallinen).');
  }
}

/* Fullscreen */
function toggleFullScreen(){
  if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
  else document.exitFullscreen().catch(()=>{});
}

/* Rooms */
function renderRoomList(){
  roomListEl.innerHTML = '';
  rooms = loadRoomsFromStorage();
  const names = Object.keys(rooms);
  if(names.length === 0){
    const note = document.createElement('div');
    note.className = 'muted';
    note.textContent = 'Ei huoneita — luo uusi';
    roomListEl.appendChild(note);
    return;
  }
  names.forEach(n => {
    const d = document.createElement('div');
    d.className = 'roomItem';
    d.textContent = '# ' + n;
    if(n === currentRoom) d.classList.add('active');
    d.addEventListener('click', ()=> {
      joinRoom(n);
    });
    roomListEl.appendChild(d);
  });
}

function onCreateRoom(){
  const name = prompt('Anna huoneen nimi (esim. yleinen)');
  if(!name) return;
  if(rooms[name]){ alert('Huone jo olemassa'); return; }
  rooms[name] = { messages: [] };
  saveRoomsToStorage(rooms);
  renderRoomList();
  joinRoom(name);
}

function onJoinRoom(){
  const name = prompt('Mihin huoneeseen liityt?');
  if(!name) return;
  if(!rooms[name]){ if(!confirm('Huonetta ei ollut olemassa — luodaanko se?')) return; rooms[name] = { messages: [] }; saveRoomsToStorage(rooms); }
  renderRoomList();
  joinRoom(name);
}

function joinRoom(name){
  currentRoom = name;
  roomTitle.textContent = '# ' + name;
  renderRoomList();
  renderMessages();
  // scroll to bottom
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* Messages */
function renderMessages(){
  chatArea.innerHTML = '';
  if(!currentRoom) { mainInfo.textContent = 'Ei huonetta'; return; }
  const r = rooms[currentRoom] || { messages: [] };
  if(r.messages.length === 0){
    mainInfo.textContent = 'Ei viestejä';
    return;
  }
  mainInfo.textContent = r.messages.length + ' viestiä';
  r.messages.forEach(m => {
    const el = makeMessageElement(m);
    chatArea.appendChild(el);
  });
  // auto-scroll
  chatArea.scrollTop = chatArea.scrollHeight;
}

function makeMessageElement(m){
  const wrapper = document.createElement('div');
  wrapper.className = 'message';
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = (m.name||'?')[0] || '?';
  avatar.style.background = m.color || getComputedStyle(document.documentElement).getPropertyValue('--guest-gray') || '#9aa0a6';
  const box = document.createElement('div');
  const header = document.createElement('div'); header.className = 'msgHeader';
  header.innerHTML = `<span>${escapeHtml(m.name || '—')}</span> <span style="font-weight:400;color:var(--muted);font-size:12px">${new Date(m.t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  const text = document.createElement('div'); text.className = 'msgBox';
  text.innerHTML = `<div class="msgText">${escapeHtml(m.text)}</div>`;
  box.appendChild(header);
  box.appendChild(text);
  wrapper.appendChild(avatar);
  wrapper.appendChild(box);
  return wrapper;
}

function sendMessage(){
  if(!currentRoom){ alert('Liity ensin huoneeseen'); return; }
  const text = (msgInput.value || '').trim();
  if(!text) return;
  const name = localStorage.getItem('chat_demo_nick') || session || 'Anon';
  const color = localStorage.getItem('chat_demo_color') || nickColor.value || '#58a6ff';
  const m = { id: Date.now() + '-' + Math.floor(Math.random()*10000), name, color, text, t: Date.now() };
  if(!rooms[currentRoom]) rooms[currentRoom] = { messages: [] };
  rooms[currentRoom].messages.push(m);
  saveRoomsToStorage(rooms);
  renderMessages();
  msgInput.value = '';
}

/* Utility */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function updateMainInfo(){ 
  if(currentRoom && rooms[currentRoom]) mainInfo.textContent = rooms[currentRoom].messages.length + ' viestiä';
  else mainInfo.textContent = 'Ei viestejä';
}

/* Mobile: toggle sidebar (simple) */
function toggleMobileSidebar(){
  if(sidebar.style.display === 'block'){ sidebar.style.display = 'none'; }
  else { sidebar.style.display = 'block'; sidebar.style.position = 'fixed'; sidebar.style.left = '0'; sidebar.style.top = '56px'; sidebar.style.height = 'calc(100% - 56px)'; sidebar.style.zIndex = 90; sidebar.style.background = 'var(--panel)'; sidebar.style.boxShadow = '0 10px 30px rgba(0,0,0,0.6)'; }
}

/* handle resizing: on desktop ensure sidebar visible and static */
function handleResize(){
  const w = window.innerWidth;
  if(w > 800){
    sidebar.style.display = 'block';
    sidebar.style.position = '';
    sidebar.style.left = '';
    sidebar.style.top = '';
    sidebar.style.height = '';
    sidebar.style.zIndex = '';
    sidebar.style.boxShadow = '';
  } else {
    // hide sidebar by default on mobile
    sidebar.style.display = 'none';
  }
}

/* Logout hook from top */
function clearSession(){
  localStorage.removeItem('chat_demo_session');
  session = null;
}

/* init done */

/* small: show login if no session set */
if(!session) showLogin();
else showAppViews();

/* keep nick inputs in sync with localStorage */
nickInput.addEventListener('input', ()=> {
  localStorage.setItem('chat_demo_nick', nickInput.value);
});
nickColor.addEventListener('input', ()=> {
  localStorage.setItem('chat_demo_color', nickColor.value);
});

/* slight UI: clicking outside mobile sidebar will close it */
document.addEventListener('click', (e)=>{
  const w = window.innerWidth;
  if(w <= 800){
    if(sidebar.style.display === 'block'){
      const rect = sidebar.getBoundingClientRect();
      if(e.target !== mobileOpen && (e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom)){
        // close
        sidebar.style.display = 'none';
      }
    }
  }
});

/* accessibility: pressing Esc closes howPanel and mobile sidebar */
document.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape'){
    howPanel.style.display = 'none';
    if(window.innerWidth <= 800 && sidebar.style.display === 'block') sidebar.style.display = 'none';
  }
});

</script>
</body>
</html>
