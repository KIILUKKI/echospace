<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Mini Chat SPA</title>
<link href="https://fonts.googleapis.com" rel="stylesheet">
<style>
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: #18191a;
  color: #eee;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* CONTAINER: M√§√§ritt√§√§ chatin leveyden ja pystysuuntaisen sijainnin */
#container { 
  display: flex; 
  flex-direction: column; 
  width: 90%; 
  max-width: 600px; /* Enemm√§n tilaa sivuille (kavennettu) */
  height: 85vh;     /* L√§hes koko n√§yt√∂n korkuinen, j√§tt√§√§ tilaa yl√∂s/alas */
}

h1 { margin: 0 0 15px 0; font-size: 1.8rem; text-align: center; flex-shrink: 0; }
.hidden { display: none !important; }

input, button { padding: 12px; margin-top: 10px; border-radius: 6px; border: none; width: 100%; font-size: 1rem; box-sizing: border-box; }
input { background: #242526; color: #eee; }
button { background: #4b9ce2; color: #fff; cursor: pointer; font-weight: 600; transition: 0.2s; }
button:hover { background: #3a8ad1; }

/* ETUSIVUN LISTAUS */
#homeView { display: flex; flex-direction: column; height: 100%; }
#roomList { 
  flex: 1; 
  overflow-y: auto; 
  background: #242526; 
  padding: 10px; 
  border-radius: 8px; 
}

/* CHAT-N√ÑKYM√ÑN KIINTE√Ñ KOKO */
#chatView { height: 100%; display: flex; flex-direction: column; }
#chatContainer { 
  display: flex; 
  flex-direction: column; 
  height: 100%; /* T√§ytt√§√§ containerin */
}

#chat { 
  flex: 1; /* Ottaa kaiken vapaan tilan kontrollien v√§liss√§ */
  overflow-y: auto; 
  background: #242526; 
  padding: 15px; 
  border-radius: 8px; 
  display: flex; 
  flex-direction: column;
}

.message { margin-bottom: 8px; word-wrap: break-word; line-height: 1.4; }
.message b { color: #4b9ce2; }

#chatControls { 
  flex-shrink: 0; /* Pit√§√§ napit ja kent√§n alhaalla vakio-osassa */
  margin-top: 10px; 
}

#backBtn { background: #e04b4b; margin-top: 5px; }
#backBtn:hover { background: #c33a3a; }
.room { padding: 12px; margin-bottom: 8px; border-radius: 5px; background: #3a3b3c; cursor: pointer; transition: 0.2s; }
.room:hover { background: #4b9ce2; color: #000; }
</style>
</head>
<body>

<div id="container">
  <h1 id="title">üî• Mini Chat</h1>

  <!-- HOME / ROOM SELECTION -->
  <div id="homeView">
    <input id="nick" placeholder="Valitse nimimerkki">
    <h3>Avoimet huoneet</h3>
    <div id="roomList"></div>
    <button id="createRoomBtn">Luo uusi huone</button>
  </div>

  <!-- ROOM CHAT -->
  <div id="chatView" class="hidden">
    <div id="chatContainer">
      <div id="chat"></div>
      <div id="chatControls">
        <input id="msg" placeholder="Kirjoita viesti (Enter l√§hett√§√§)">
        <button id="backBtn">Poistu huoneesta</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com";

const firebaseConfig = {
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  authDomain: "chat-fc8ef.firebaseapp.com",
  projectId: "chat-fc8ef",
  storageBucket: "chat-fc8ef.appspot.com",
  messagingSenderId: "446356718094",
  appId: "1:446356718094:web:f56514352845d6bbb7b25f"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let unsub = null;
const chat = document.getElementById("chat");
const roomList = document.getElementById("roomList");
const msgInput = document.getElementById("msg");
const nickInput = document.getElementById("nick");

let nick = localStorage.getItem("nick") || "";
if(nick) nickInput.value = nick;

msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });

async function loadRooms(){
  roomList.innerHTML="";
  const roomsSnap = await getDocs(collection(db,"rooms"));
  roomsSnap.forEach(r=>{
    const div=document.createElement("div");
    div.className="room";
    div.innerText=r.id;
    div.onclick=async ()=>{
      const pass = prompt(`Sy√∂t√§ salasana huoneeseen "${r.id}"`);
      if(pass===null) return;
      joinRoom(r.id,pass);
    };
    roomList.appendChild(div);
  });
}
loadRooms();

document.getElementById("createRoomBtn").addEventListener("click", async ()=>{
  const roomName = prompt("Huoneen nimi");
  if(!roomName) return;
  const pass = prompt("Aseta salasana");
  if(pass===null) return;
  joinRoom(roomName,pass);
});

async function joinRoom(roomName,password){
  nick = nickInput.value.trim()||"Anonyymi";
  localStorage.setItem("nick",nick);
  currentRoom=roomName;

  const roomRef = doc(db,"rooms",roomName);
  const snap = await getDoc(roomRef);
  const now=Date.now();
  const day=24*60*60*1000;
  
  if(!snap.exists()){
    await setDoc(roomRef,{password,roomExpiresAt:new Date(now+day)});
  } else {
    if(snap.data().password!==password){ alert("V√§√§r√§ salasana"); return; }
    await setDoc(roomRef,{roomExpiresAt:new Date(now+day)},{merge:true});
  }

  document.getElementById("homeView").classList.add("hidden");
  document.getElementById("chatView").classList.remove("hidden");
  document.getElementById("title").innerText=`Room: ${roomName}`;

  const q = query(collection(db,"rooms",roomName,"messages"),orderBy("time"));
  unsub = onSnapshot(q,snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m = d.data();
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<b>${m.name}:</b> ${m.text}`;
      chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

async function send(){
  const text=msgInput.value.trim();
  if(!text) return;
  if(text==="/clear"){
    if(!confirm("Tyhjennet√§√§nk√∂ viestit?")) return;
    const msgs=await getDocs(collection(db,"rooms",currentRoom,"messages"));
    msgs.forEach(d=>deleteDoc(d.ref));
    msgInput.value=""; return;
  }
  if(text==="/delete"){
    if(!confirm("POISTETAANKO KOKO HUONE?")) return;
    const msgs=await getDocs(collection(db,"rooms",currentRoom,"messages"));
    msgs.forEach(d=>deleteDoc(d.ref));
    await deleteDoc(doc(db,"rooms",currentRoom));
    location.reload(); return;
  }

  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    name:nick,
    text,
    time:serverTimestamp()
  });
  msgInput.value="";
}

document.getElementById("backBtn").addEventListener("click",()=>{
  if(unsub) unsub();
  unsub=null;
  document.getElementById("chatView").classList.add("hidden");
  document.getElementById("homeView").classList.remove("hidden");
  document.getElementById("title").innerText="üî• Mini Chat";
  loadRooms();
});
</script>
</body>
</html>
