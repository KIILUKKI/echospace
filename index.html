<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat ‚Äì Discord Style</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing:border-box; }

body {
  margin:0;
  height:100vh;
  font-family:Inter, sans-serif;
  background:#1e1f22;
  color:#dbdee1;
  display:flex;
}

/* ===== LAYOUT ===== */
#app {
  display:flex;
  width:100%;
  height:100%;
}

/* ===== SIDEBAR ===== */
#sidebar {
  width:240px;
  background:#2b2d31;
  padding:12px;
  display:flex;
  flex-direction:column;
}

.room {
  padding:10px;
  border-radius:6px;
  margin-bottom:4px;
  cursor:pointer;
}
.room:hover { background:#404249; }

/* ===== MAIN ===== */
#main {
  flex:1;
  display:flex;
  flex-direction:column;
}

/* HEADER */
#header {
  height:48px;
  background:#313338;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  border-bottom:1px solid #1f2023;
}

#headerLeft {
  display:flex;
  align-items:center;
  gap:10px;
}

#header button {
  background:none;
  border:none;
  color:#dbdee1;
  cursor:pointer;
  font-size:14px;
}
#header button:hover { color:#fff; }

/* CHAT */
#chat {
  flex:1;
  padding:16px;
  overflow-y:auto;
}

.message {
  margin-bottom:14px;
}
.message b {
  color:#fff;
}
.time {
  font-size:11px;
  color:#949ba4;
  margin-left:6px;
}

/* TYPING */
#typing {
  height:18px;
  font-size:12px;
  color:#949ba4;
  padding-left:16px;
}

/* INPUT */
#inputBar {
  padding:12px;
  background:#383a40;
  border-top:1px solid #1f2023;
}

#inputBar input {
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  background:#1e1f22;
  color:#dbdee1;
}

/* USERS */
#users {
  width:220px;
  background:#2b2d31;
  padding:12px;
  transition:.25s;
}
#users.hidden { width:0; padding:0; overflow:hidden; }

#toggleUsers {
  cursor:pointer;
  font-size:14px;
}

/* HOME */
#home {
  position:absolute;
  inset:0;
  background:#1e1f22;
  display:flex;
}

#homeLeft {
  width:240px;
  background:#2b2d31;
  padding:12px;
}

#homeCenter {
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

#homeCenter input, #homeCenter button {
  width:300px;
  padding:14px;
  margin-bottom:12px;
  border-radius:8px;
  border:none;
}
#homeCenter input {
  background:#2b2d31;
  color:#fff;
}
#homeCenter button {
  background:#5865f2;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
</style>
</head>

<body>
<div id="app">

<!-- HOME -->
<div id="home">
  <div id="homeLeft"><div id="roomList"></div></div>
  <div id="homeCenter">
    <input id="nick" placeholder="Username">
    <button id="createRoom">Create / Join Room</button>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar"></div>

<!-- MAIN -->
<div id="main">
  <div id="header">
    <div id="headerLeft">
      <button id="back">‚Üê Return</button>
      <span id="roomName">Select room</span>
    </div>
    <span id="toggleUsers">üë•</span>
  </div>

  <div id="chat"></div>
  <div id="typing"></div>

  <div id="inputBar">
    <input id="msg" placeholder="Message...">
  </div>
</div>

<!-- USERS -->
<div id="users" class="hidden">
  <b>Online</b>
  <div id="userList"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy, onSnapshot,
  serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
});
const db = getFirestore(app);

let room="", nick="", unsub;

const chat=document.getElementById("chat");
const typingEl=document.getElementById("typing");

/* ROOMS */
async function loadRooms(){
  roomList.innerHTML="";
  const s=await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.textContent="# "+r.id;
    d.onclick=()=>join(r.id);
    roomList.appendChild(d);
  });
}
loadRooms();

/* JOIN */
async function join(r){
  const pass=prompt("Password");
  if(pass===null) return;
  nick=document.getElementById("nick").value||"Anon";
  localStorage.setItem("nick",nick);

  const ref=doc(db,"rooms",r);
  const snap=await getDoc(ref);
  if(!snap.exists()) await setDoc(ref,{password:pass});
  else if(snap.data().password!==pass) return alert("Wrong");

  document.getElementById("home").style.display="none";
  room=r;
  roomName.textContent="# "+r;

  const q=query(collection(db,"rooms",r,"messages"),orderBy("time"));
  unsub=onSnapshot(q,s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const t=m.time?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      chat.innerHTML+=`<div class="message"><b>${m.name}</b><span class="time">${t}</span><div>${m.text}</div></div>`;
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

/* SEND */
msg.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    addDoc(collection(db,"rooms",room,"messages"),{
      name:nick,text:msg.value,time:serverTimestamp()
    });
    msg.value="";
  } else {
    typingEl.textContent=nick+" is typing...";
    setTimeout(()=>typingEl.textContent="",1200);
  }
});

/* BACK */
back.onclick=()=>{
  if(unsub) unsub();
  home.style.display="flex";
};

/* TOGGLE USERS */
toggleUsers.onclick=()=>{
  users.classList.toggle("hidden");
};

/* CREATE */
createRoom.onclick=()=>{
  const r=prompt("Room name");
  if(r) join(r);
};
</script>
</body>
</html>
