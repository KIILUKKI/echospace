<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body { margin: 0; height: 100vh; font-family: Inter, sans-serif; background: #0b0f14; color: #e6edf3; display: flex; }
#app { display: flex; width: 100%; height: 100%; position: relative; }

/* HOME */
#home { position: absolute; inset: 0; display: flex; }
#homeLeft { width: 260px; background: #161b22; padding: 16px; overflow-y: auto; border-right:1px solid #0d1117;}
#homeCenter { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
#nickRow { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; width: 320px; }
#nick { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #161b22; color: #fff; }
#nickColor { width: 36px; height: 36px; border: none; cursor: pointer; outline: none; }

/* ROOMS */
.room { padding: 10px; border-radius: 8px; background: #161b22; margin-bottom: 8px; cursor: pointer; display:flex; justify-content:space-between; align-items:center;}
.room:hover { background: #21262d; }

/* MAIN */
#main { flex: 1; display: flex; flex-direction: column; display: none; }
#header { height: 52px; background: #161b22; display: flex; align-items: center; padding: 0 14px; border-bottom: 1px solid #0d1117; }
#header button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; margin-right: 10px; }
#roomName { font-weight: 600; }
#chatWrapper { display: flex; flex: 1; overflow: hidden; }
#chatSidebar { width: 260px; background: #161b22; border-right: 1px solid #0d1117; padding: 10px; }
#chatWrapperMain { flex:1; display:flex; flex-direction:column; }
#chat { flex: 1; padding: 16px; overflow-y: auto; display:flex; flex-direction:column; gap: 10px; }

/* MESSAGE */
.message { display: flex; gap: 10px; margin-bottom: 14px; }
.avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #000; flex-shrink: 0; }
.msg { background: #161b22; padding: 10px 14px; border-radius: 10px; width: 100%; position: relative; word-break: break-word; }
.msg b { margin-right: 6px; }
.time { font-size: 11px; color: #8b949e; margin-left: 6px; }
.reply-btn { position: absolute; right: 8px; top: 8px; font-size: 12px; color: #8b949e; cursor: pointer; opacity: 0; transition: .15s; }
.msg:hover .reply-btn { opacity: 1; }
.reply-preview { background: #0d1117; border-left: 3px solid #58a6ff; padding: 6px; font-size: 12px; margin-bottom: 6px; }

/* INPUT */
#replyBox { display: none; background: #21262d; padding: 8px 14px; font-size: 12px; }
#replyBox span { color: #58a6ff; }
#replyBox button { background: none; border: none; color: #8b949e; cursor: pointer; margin-left: 8px; }
#inputBar { padding: 14px; background: #161b22; border-top: 1px solid #0d1117; display: flex; align-items: center; gap: 8px; position: relative; }
#msg { flex: 1; padding: 14px; border-radius: 8px; border: none; background: #0d1117; color: #fff; }

/* Emoji picker */
#emojiPicker { display:flex; flex-wrap:wrap; gap:4px; padding:4px; background:#21262d; border-radius:8px; position:absolute; bottom:60px; left:14px; display:none; z-index:1000; }
#emojiPicker div { cursor:pointer; font-size:18px; }
#emojiBtn { padding:0 8px; font-size:18px; border:none; background:#161b22; color:#fff; cursor:pointer; border-radius:8px; }

/* Typing indicator */
#typingIndicator { font-size:12px; color:#8b949e; margin:2px 0 0 0; }

/* CREATE/JOIN BUTTON */
#createRoom { padding: 12px 24px; border-radius: 12px; background:#58a6ff; color:#000; border:none; font-weight:600; cursor:pointer; font-size:16px; transition:.15s; }
#createRoom:hover { background:#3f83d0; }
</style>
</head>
<body>
<div id="app">

<!-- HOME -->
<div id="home">
  <div id="homeLeft">
    <div id="roomList"></div>
  </div>
  <div id="homeCenter">
    <div id="nickRow">
      <input id="nick" placeholder="Username">
      <input type="color" id="nickColor" value="#58a6ff">
    </div>
    <button id="createRoom">Create / Join Room</button>
  </div>
</div>

<!-- MAIN -->
<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName">Select room</span>
  </div>

  <div id="chatWrapper">
    <div id="chatSidebar"></div>
    <div id="chatWrapperMain">
      <div id="chat"></div>
      <div id="typingIndicator"></div>
    </div>
  </div>

  <div id="replyBox"></div>
  <div id="inputBar">
    <input id="msg" placeholder="Message... (/clear /delete /deletelast)">
    <button id="emojiBtn">üòä</button>
    <div id="emojiPicker"></div>
  </div>

</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId: "chat-fc8ef"
});
const db = getFirestore(app);

let room="", nick="", nickColor="#58a6ff", replyTo=null;
const chat=document.getElementById("chat");
const msg=document.getElementById("msg");
const roomList=document.getElementById("roomList");
const replyBox=document.getElementById("replyBox");
const roomName=document.getElementById("roomName");
const emojiPicker=document.getElementById("emojiPicker");
const emojiBtn=document.getElementById("emojiBtn");
const typingIndicator=document.getElementById("typingIndicator");

// Load stored nick/color
document.getElementById("nick").value=localStorage.getItem("nick")||"";
document.getElementById("nickColor").value=localStorage.getItem("nickColor")||"#58a6ff";
document.getElementById("nickColor").oninput=()=>localStorage.setItem("nickColor", document.getElementById("nickColor").value);

// Load rooms
async function loadRooms(){
  roomList.innerHTML="";
  const s=await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d=document.createElement("div");
    d.className="room"; d.textContent="# "+r.id;
    d.onclick=()=>joinRoom(r.id);
    roomList.appendChild(d);
  });
}

// Create/join room
document.getElementById("createRoom").onclick=async ()=>{
  const r=prompt("Room name"); if(!r)return;
  const p=prompt("Password (optional)"); if(p===null)return;
  const roomRef=doc(db,"rooms",r);
  if(!(await getDoc(roomRef)).exists()) await setDoc(roomRef,{password:p||"", created:serverTimestamp()});
  joinRoom(r);
};

// Join room
async function joinRoom(r){
  const roomRef=doc(db,"rooms",r);
  const snap=await getDoc(roomRef);
  if(!snap.exists()) return alert("Room doesn't exist");
  const pass = prompt("Password");
  if(pass===null) return;
  if(snap.data().password!==pass) return alert("Wrong password");

  nick=document.getElementById("nick").value||("Anon"+Math.floor(Math.random()*1000));
  nickColor=document.getElementById("nickColor").value;
  localStorage.setItem("nick",nick);
  localStorage.setItem("nickColor",nickColor);

  document.getElementById("home").style.display="none";
  document.getElementById("main").style.display="flex";
  room=r; roomName.textContent="# "+r;

  // Listen messages
  onSnapshot(query(collection(db,"rooms",room,"messages"),orderBy("time")), snapshot=>{
    chat.innerHTML="";
    snapshot.forEach(d=>{
      const m=d.data();
      const t=m.time?.toDate();
      const msgDiv=document.createElement("div");
      msgDiv.className="message";
      msgDiv.innerHTML=`
        <div class="avatar" style="background:${m.color}">${m.name[0]}</div>
        <div class="msg">
          ${m.reply?`<div class="reply-preview"><b>${m.reply.name}</b>: ${m.reply.text}</div>`:""}
          <b style="color:${m.color}">${m.name}</b>
          <span class="time">${t?t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):""}</span>
          <div>${m.text}</div>
          ${!m.reply?`<div class="reply-btn" data-name="${m.name}" data-text="${m.text}">reply</div>`:""}
        </div>`;
      chat.appendChild(msgDiv);
    });
    chat.scrollTop=chat.scrollHeight;
  });

  // Typing indicator
  const typingRef=collection(db,"rooms",room,"typing");
  onSnapshot(typingRef,snap=>{
    const names=[];
    snap.forEach(d=>{ if(d.id!==nick && d.data().typing) names.push(d.id); });
    typingIndicator.textContent=names.length===0?"":names.length===1?`${names[0]} is typing...`:`${names.join(", ")} are typing...`;
  });

  let typingTimeout;
  msg.addEventListener("input",()=>{
    setDoc(doc(typingRef,nick),{typing:true});
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>setDoc(doc(typingRef,nick),{typing:false}),1500);
  });
}

// Reply
chat.addEventListener("click",e=>{
  const b=e.target.closest(".reply-btn");
  if(!b)return;
  replyTo={name:b.dataset.name,text:b.dataset.text};
  replyBox.style.display="block";
  replyBox.innerHTML=`Replying to <span>${replyTo.name}</span><button onclick="cancelReply()">x</button>`;
});
window.cancelReply=()=>{replyTo=null; replyBox.style.display="none"}

// Send message
msg.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;
  const text=msg.value.trim(); msg.value=""; if(!text) return;

  if(text==="/clear"){
    const msgs=await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref); return;
  }
  if(text==="/delete"){
    if(!confirm("Delete entire room and all messages?")) return;
    try{
      const msgs=await getDocs(collection(db,"rooms",room,"messages"));
      for(const d of msgs.docs) await deleteDoc(d.ref);
      await deleteDoc(doc(db,"rooms",room));
      alert("Room deleted"); location.reload();
    }catch(err){console.error(err); alert("Failed to delete room");}
    return;
  }

  await addDoc(collection(db,"rooms",room,"messages"),{name:nick,text,reply:replyTo,color:nickColor,time:serverTimestamp()});
  replyTo=null; replyBox.style.display="none";
});

// Back
document.getElementById("back").onclick=()=>location.reload();

// Notifications
if(Notification.permission!=="granted") Notification.requestPermission();

// Emoji picker
const emojis=["üòÄ","üòÇ","üòé","üòç","üëç","‚ù§Ô∏è","üéâ","üò¢","ü§î","üôå","üî•","üíØ"];
emojiPicker.innerHTML=""; emojis.forEach(e=>{ const b=document.createElement("div"); b.textContent=e; b.onclick=()=> msg.value+=e; emojiPicker.appendChild(b); });
emojiBtn.onclick=e=>{e.preventDefault(); emojiPicker.style.display=emojiPicker.style.display==="none"?"flex":"none";}
msg.addEventListener("focus",()=>emojiPicker.style.display="none");

loadRooms();
</script>
</body>
</html>
