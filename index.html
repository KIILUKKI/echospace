<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniChat – Discord Style</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {box-sizing: border-box;}
    body {margin: 0; height: 100vh; font-family: Inter, sans-serif; background: #1e1f22; color: #dbdee1; display: flex;}
    #app {display: flex; width: 100%; height: 100%;}
    #sidebar {width: 240px; background: #2b2d31; padding: 12px; display: flex; flex-direction: column;}
    #main {flex: 1; display: flex; flex-direction: column;}
    #header {height: 48px; background: #313338; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; border-bottom: 1px solid #1f2023;}
    #headerLeft {display: flex; align-items: center; gap: 10px;}
    #header button {background: none; border: none; color: #dbdee1; cursor: pointer; font-size: 14px;}
    #header button:hover {color: #fff;}
    #chat {flex: 1; padding: 16px; overflow-y: auto;}
    .message {margin-bottom: 14px; position: relative;}
    .message b {color: #fff;}
    .time {font-size: 11px; color: #949ba4; margin-left: 6px;}
    #inputBar {padding: 12px; background: #383a40; border-top: 1px solid #1f2023; display: flex; gap: 6px;}
    #inputBar input {flex: 1; padding: 12px; border-radius: 8px; border: none; background: #1e1f22; color: #dbdee1;}
    #home {position: absolute; inset: 0; background: #1e1f22; display: flex;}
    #homeLeft {width: 240px; background: #2b2d31; padding: 12px;}
    #homeCenter {flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;}
    #homeCenter input, #homeCenter button {width: 300px; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: none;}
    #homeCenter input {background: #2b2d31; color: #fff;}
    #homeCenter button {background: #5865f2; color: #fff; font-weight: 600; cursor: pointer;}
  </style>
</head>
<body>
  <div id="app">
    <!-- HOME -->
    <div id="home">
      <div id="homeLeft"><div id="roomList"></div></div>
      <div id="homeCenter">
        <input id="nick" placeholder="Username">
        <button id="createRoom">Create / Join Room</button>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar"></div>

    <!-- MAIN -->
    <div id="main">
      <div id="header">
        <div id="headerLeft">
          <button id="back">← Return</button>
          <span id="roomName">Select room</span>
        </div>
      </div>

      <div id="chat"></div>
      <div id="typing"></div>

      <div id="inputBar">
        <input id="msg" placeholder="Message... (/clear, /delete, /deletelast)">
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection,
      addDoc, getDocs, query, orderBy,
      onSnapshot, serverTimestamp, deleteDoc, limit, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
      projectId: "chat-fc8ef"
    });
    const db = getFirestore(app);

    /* STATE */
    let room = "", nick = "", unsub;
    let lastNotifiedTime = null;

    /* ELEMENTS */
    const chat = document.getElementById("chat");
    const typingEl = document.getElementById("typing");
    const msg = document.getElementById("msg");
    const roomList = document.getElementById("roomList");

    /* PERSIST */
    document.getElementById("nick").value = localStorage.getItem("nick") || "";

    /* LOAD ROOMS */
    async function loadRooms() {
      roomList.innerHTML = "";
      const s = await getDocs(collection(db, "rooms"));
      s.forEach(r => {
        const d = document.createElement("div");
        d.className = "room";
        d.textContent = "# " + r.id;
        d.onclick = () => join(r.id);
        roomList.appendChild(d);
      });
    }
    loadRooms();

    /* CREATE ROOM */
    document.getElementById("createRoom").onclick = async () => {
      const roomName = prompt("Enter room name:");
      if (!roomName) return;

      const existingRoom = await getDoc(doc(db, "rooms", roomName));
      if (existingRoom.exists()) return alert("Room already exists!");

      // Kysy salasanaa huoneelle
      const password = prompt("Set a password for the room (optional):");
      const roomData = { password: password || "" };

      // Create room in Firestore
      await setDoc(doc(db, "rooms", roomName), roomData);
      loadRooms(); // Reload the rooms list
      alert(`Room #${roomName} created successfully!`);
    };

    /* JOIN ROOM */
    async function join(r) {
      const pass = prompt("Password");
      if (pass === null) return;
      nick = document.getElementById("nick").value || ("Anon" + Math.floor(Math.random() * 1000));
      localStorage.setItem("nick", nick);

      const ref = doc(db, "rooms", r);
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { password: pass });
      else if (snap.data().password !== pass) return alert("Wrong");

      document.getElementById("home").style.display = "none";
      room = r;
      roomName.textContent = "# " + r;

      const userRef = doc(db, "rooms", room, "users", nick);
      await setDoc(userRef, { online: true, lastActivity: serverTimestamp() });
      window.addEventListener("beforeunload", () => deleteDoc(userRef));

      /* Messages + notifications */
      const q = query(collection(db, "rooms", room, "messages"), orderBy("time"));
      unsub = onSnapshot(q, s => {
        chat.innerHTML = "";
        let lastMessage = null;

        s.forEach(d => {
          const m = d.data();
          const t = m.time?.toDate();
          lastMessage = { name: m.name, text: m.text, time: t };

          chat.innerHTML += `
            <div class="message">
              <b>${m.name}</b>
              <span class="time">${t?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || ""}</span>
              <div>${m.text}</div>
            </div>
          `;
        });

        if (lastMessage && document.hidden && lastMessage.name !== nick && Notification.permission === "granted") {
          new Notification("New message", { body: `${lastMessage.name}: ${lastMessage.text}` });
        }

        chat.scrollTop = chat.scrollHeight;
      });
    }

    /* SEND MESSAGE + /commands */
    msg.addEventListener("keydown", async e => {
      if (e.key !== "Enter") return;
      const text = msg.value.trim();
      msg.value = "";
      if (!text) return;

      /* ----- SLASH COMMANDS ----- */
      if (text === "/clear") {
        // Clear all messages in the room
        const q = query(collection(db, "rooms", room, "messages"));
        const s = await getDocs(q);
        const batch = writeBatch(db);
        s.forEach(d => batch.delete(d.ref));
        await batch.commit();
        return;
      }

      if (text === "/delete") {
        // Delete the entire room and all its messages and users
        const roomRef = doc(db, "rooms", room);
        const messagesRef = collection(db, "rooms", room, "messages");
        const usersRef = collection(db, "rooms", room, "users");

        const batch = writeBatch(db);

        try {
          // Delete all messages
          const messages = await getDocs(messagesRef);
          messages.forEach(d => batch.delete(d.ref));

          // Delete all users
          const users = await getDocs(usersRef);
          users.forEach(u => batch.delete(u.ref));

          // Delete the room itself
          batch.delete(roomRef);

          await batch.commit();
          alert("Room and all its messages have been deleted.");
          location.reload(); // Refresh page
        } catch (error) {
          console.error("Error deleting room: ", error);
        }
        return;
      }

      if (text === "/deletelast") {
        // Remove only the last sent message of the user
        const q = query(
          collection(db, "rooms", room, "messages"),
          orderBy("time", "desc"),
          limit(1)
        );
        const s = await getDocs(q);
        s.forEach(d => {
          if (d.data().name === nick) deleteDoc(d.ref); // Remove the last message
        });
        return;
      }
      /* -------------------------- */

      await addDoc(collection(db, "rooms", room, "messages"), {
        name: nick,
        text,
        time: serverTimestamp()
      });
    });

    /* UI Controls */
    back.onclick = () => {
      location.reload(); // Refresh the page when "Return" is clicked
    };

    /* Notifications */
    if (Notification.permission !== "granted") Notification.requestPermission();
  </script>
</body>
</html>
