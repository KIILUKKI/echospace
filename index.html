<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat ‚Äì Discord Style</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;}
body{margin:0;height:100vh;font-family:Inter,sans-serif;background:#1e1f22;color:#dbdee1;display:flex;}
#app{display:flex;width:100%;height:100%;}
#sidebar{width:240px;background:#2b2d31;padding:12px;}
.room{padding:10px;border-radius:6px;margin-bottom:4px;cursor:pointer;}
.room:hover{background:#404249;}
#main{flex:1;display:flex;flex-direction:column;}
#header{height:48px;background:#313338;display:flex;align-items:center;justify-content:space-between;padding:0 12px;border-bottom:1px solid #1f2023;}
#chat{flex:1;padding:16px;overflow-y:auto;}
.message{margin-bottom:14px;}
.message b{color:#fff;}
.time{font-size:11px;color:#949ba4;margin-left:6px;}
#typing{height:18px;font-size:12px;color:#949ba4;padding-left:16px;}
#inputBar{padding:12px;background:#383a40;border-top:1px solid #1f2023;}
#inputBar input{width:100%;padding:12px;border-radius:8px;border:none;background:#1e1f22;color:#dbdee1;}
#users{width:220px;background:#2b2d31;padding:12px;}
.hidden{display:none;}
</style>
</head>
<body>

<div id="app">

<div id="home">
  <input id="nick" placeholder="Username">
  <button id="createRoom">Create / Join Room</button>
  <div id="roomList"></div>
</div>

<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName"></span>
    <span id="toggleUsers">üë•</span>
  </div>

  <div id="chat"></div>
  <div id="typing"></div>

  <div id="inputBar">
    <input id="msg" placeholder="Message... (/clear, /delete)">
  </div>
</div>

<div id="users" class="hidden">
  <b>Online</b>
  <div id="userList"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc, limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
});
const db = getFirestore(app);

let room="", nick="", unsub;
let lastNotifiedTime=null;

const chat=document.getElementById("chat");
const msg=document.getElementById("msg");

/* ROOMS */
async function loadRooms(){
  roomList.innerHTML="";
  const s=await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.textContent="# "+r.id;
    d.onclick=()=>join(r.id);
    roomList.appendChild(d);
  });
}
loadRooms();

/* JOIN */
async function join(r){
  nick=document.getElementById("nick").value || "Anon";
  room=r;
  roomName.textContent="# "+r;
  home.style.display="none";

  await setDoc(doc(db,"rooms",room),{exists:true},{merge:true});
  await setDoc(doc(db,"rooms",room,"users",nick),{online:true});

  /* USERS */
  onSnapshot(collection(db,"rooms",room,"users"),s=>{
    userList.innerHTML="";
    s.forEach(u=>userList.innerHTML+=`<div>üü¢ ${u.id}</div>`);
  });

  /* MESSAGES */
  const q=query(collection(db,"rooms",room,"messages"),orderBy("time"));
  unsub=onSnapshot(q,s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const t=m.time?.toDate();
      chat.innerHTML+=`
        <div class="message">
          <b>${m.name}</b>
          <span class="time">${t?.toLocaleTimeString()||""}</span>
          <div>${m.text}</div>
        </div>
      `;

      if(
        document.hidden &&
        m.name!==nick &&
        t &&
        (!lastNotifiedTime || t>lastNotifiedTime) &&
        Notification.permission==="granted"
      ){
        new Notification("New message",{body:`${m.name}: ${m.text}`});
      }

      if(t) lastNotifiedTime=t;
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

/* SEND + COMMANDS */
msg.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;

  const text=msg.value.trim();
  msg.value="";

  if(!text) return;

  /* ---------- COMMANDS ---------- */
  if(text==="/clear"){
    chat.innerHTML="";
    return;
  }

  if(text==="/delete"){
    const q=query(
      collection(db,"rooms",room,"messages"),
      orderBy("time","desc"),
      limit(1)
    );
    const s=await getDocs(q);
    s.forEach(d=>{
      if(d.data().name===nick) deleteDoc(d.ref);
    });
    return;
  }
  /* ------------------------------ */

  addDoc(collection(db,"rooms",room,"messages"),{
    name:nick,
    text,
    time:serverTimestamp()
  });
});

/* UI */
toggleUsers.onclick=()=>users.classList.toggle("hidden");
back.onclick=()=>location.reload();

if(Notification.permission!=="granted"){
  Notification.requestPermission();
}
</script>
</body>
</html>
