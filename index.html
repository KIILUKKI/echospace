<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ”¥ Mini Chat SPA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
/* Perusasetukset */
body {
  margin:0;
  font-family:'Inter',sans-serif;
  background:#18191a;
  color:#eee;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

#container {
  display:flex;
  width:90%;
  max-width:1000px;
  height:80vh;
  background:#1e1f22;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
}

/* Vasemmanpuoleinen valikko */
#homeView, #roomList {
  display:flex;
  flex-direction:column;
}

#sidebar {
  width:250px;
  background:#242526;
  padding:15px;
  display:flex;
  flex-direction:column;
}

#sidebar h2 {
  margin:0 0 10px 0;
  font-size:1.2rem;
  text-align:center;
}

#nick {
  margin-bottom:15px;
  padding:10px;
  border-radius:6px;
  border:none;
  background:#3a3b3e;
  color:#eee;
}

.room {
  padding:10px;
  margin-bottom:8px;
  border-radius:6px;
  background:#2a2b2d;
  cursor:pointer;
  transition:0.2s;
  text-align:center;
}
.room:hover {
  background:#4b9ce2;
  color:#000;
}

/* Oikea chat-alue */
#chatView {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:15px;
  background:#18191a;
}

#title {
  margin:0 0 10px 0;
  text-align:center;
  font-size:1.6rem;
  font-weight:600;
}

#chatContainer {
  display:flex;
  flex-direction:column;
  flex:1;
}

#chat {
  flex:1;
  background:#242526;
  border-radius:8px;
  padding:15px;
  overflow-y:auto;
  margin-bottom:10px;
}

.message { margin-bottom:10px; word-wrap:break-word; }
.message b { color:#4b9ce2; }

#chatControls {
  display:flex;
  gap:10px;
}

#chatControls input {
  flex:1;
  padding:10px;
  border-radius:6px;
  border:none;
  background:#3a3b3e;
  color:#eee;
}

#chatControls button {
  padding:10px 15px;
  border-radius:6px;
  border:none;
  background:#4b9ce2;
  color:#fff;
  cursor:pointer;
  font-weight:600;
  transition:0.2s;
}
#chatControls button:hover { background:#3a8ad1; }
#backBtn { background:#e04b4b; }
#backBtn:hover { background:#c33a3a; }

/* Mobile-friendly */
@media(max-width:800px){
  #container { flex-direction:column; height:90vh; }
  #sidebar { width:100%; flex-direction:row; overflow-x:auto; padding:5px; }
  .room { flex:1; margin:0 5px 0 0; }
}
</style>
</head>
<body>
<div id="container">
  <!-- Vasen sivupalkki -->
  <div id="sidebar">
    <h2>Rooms</h2>
    <input id="nick" placeholder="Nickname">
    <div id="roomList"></div>
    <button id="createRoomBtn">+ Create Room</button>
  </div>

  <!-- Chat-alue -->
  <div id="chatView" class="hidden">
    <h1 id="title">ðŸ”¥ Mini Chat</h1>
    <div id="chatContainer">
      <div id="chat"></div>
      <div id="chatControls">
        <input id="msg" placeholder="Type a message (Enter = send)">
        <button id="backBtn">Return</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  authDomain: "chat-fc8ef.firebaseapp.com",
  projectId: "chat-fc8ef",
  storageBucket: "chat-fc8ef.appspot.com",
  messagingSenderId: "446356718094",
  appId: "1:446356718094:web:f56514352845d6bbb7b25f"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let unsub = null;
const chat = document.getElementById("chat");
const roomList = document.getElementById("roomList");
const msgInput = document.getElementById("msg");
const nickInput = document.getElementById("nick");

// Load nickname from localStorage
let nick = localStorage.getItem("nick") || "";
if(nick) nickInput.value = nick;

// ENTER = send
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });

// Load rooms
async function loadRooms(){
  roomList.innerHTML="";
  const roomsSnap = await getDocs(collection(db,"rooms"));
  roomsSnap.forEach(r=>{
    const div=document.createElement("div");
    div.className="room";
    div.innerText=r.id;
    div.onclick=async ()=>{
      const pass = prompt(`Enter password for room "${r.id}"`);
      if(pass===null) return;
      joinRoom(r.id,pass);
    };
    roomList.appendChild(div);
  });
}
loadRooms();

// Create new room
document.getElementById("createRoomBtn").addEventListener("click", async ()=>{
  const roomName = prompt("Enter new room name");
  if(!roomName) return;
  const pass = prompt("Enter password for this room");
  if(pass===null) return;
  joinRoom(roomName,pass);
});

// Join room
async function joinRoom(roomName,password){
  nick = nickInput.value.trim()||"Anon";
  if(!nick){ alert("Enter nickname"); return; }
  localStorage.setItem("nick",nick);
  currentRoom=roomName;

  const roomRef = doc(db,"rooms",roomName);
  const snap = await getDoc(roomRef);
  const now=Date.now();
  const day=24*60*60*1000;
  if(!snap.exists()){
    await setDoc(roomRef,{password,roomExpiresAt:new Date(now+day)});
  } else {
    if(snap.data().password!==password){ alert("Wrong password"); return; }
    await setDoc(roomRef,{roomExpiresAt:new Date(now+day)},{merge:true});
  }

  document.getElementById("chatView").classList.remove("hidden");

  // Load chat realtime
  const q = query(collection(db,"rooms",roomName,"messages"),orderBy("time"));
  unsub = onSnapshot(q,snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m = d.data();
      chat.innerHTML+=`<div class="message"><b>${m.name}:</b> ${m.text}</div>`;
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

// Send message
async function send(){
  const text=msgInput.value.trim();
  if(!text) return;
  if(text==="/clear"){
    if(!confirm("Clear all messages?")) return;
    const msgs=await getDocs(collection(db,"rooms",currentRoom,"messages"));
    msgs.forEach(d=>deleteDoc(d.ref));
    msgInput.value=""; return;
  }
  if(text==="/delete"){
    if(!confirm("DELETE ENTIRE ROOM?")) return;
    const msgs=await getDocs(collection(db,"rooms",currentRoom,"messages"));
    msgs.forEach(d=>deleteDoc(d.ref));
    await deleteDoc(doc(db,"rooms",currentRoom));
    location.reload(); return;
  }

  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    name:nick,
    text,
    time:serverTimestamp(),
    expiresAt:new Date(Date.now()+24*60*60*1000)
  });
  msgInput.value="";
}

// Back button
document.getElementById("backBtn").addEventListener("click",()=>{
  if(unsub) unsub();
  unsub=null;
  document.getElementById("chatView").classList.add("hidden");
  loadRooms();
});
</script>
</body>
</html>
