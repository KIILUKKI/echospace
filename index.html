<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>DC Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  height:100vh;
  background:#1e1f22;
  color:#fff;
  display:flex;
}

/* ===== LAYOUT ===== */
#rooms{
  width:220px;
  background:#111214;
  padding:10px;
  border-right:1px solid #2b2d31;
}
#rooms h3{margin:5px 0}
.room{
  padding:8px;
  border-radius:5px;
  cursor:pointer;
}
.room:hover{background:#2b2d31}

#main{
  flex:1;
  display:flex;
  flex-direction:column;
}

#top{
  height:48px;
  background:#2b2d31;
  display:flex;
  align-items:center;
  padding:0 10px;
  gap:10px;
}
#back{cursor:pointer}

#chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
}

.msg{
  margin-bottom:8px;
}
.msg b{color:#5dade2}
.time{
  color:#aaa;
  font-size:11px;
  margin-left:6px;
}

#typing{
  font-size:12px;
  color:#aaa;
  padding:0 10px;
}

#input{
  display:flex;
  padding:10px;
  background:#2b2d31;
}
#input input{
  flex:1;
  padding:10px;
  border-radius:5px;
  border:none;
}
#input button{
  margin-left:6px;
}

/* ===== USERS ===== */
#users{
  width:180px;
  background:#111214;
  border-left:1px solid #2b2d31;
  padding:10px;
  transition:width .2s;
}
#users.hidden{
  width:0;
  padding:0;
  overflow:hidden;
}
#toggleUsers{
  cursor:pointer;
}
#userList div{
  padding:6px;
  border-radius:4px;
}
#userList div:hover{
  background:#2b2d31;
}

/* ===== HOME ===== */
#home{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#1e1f22;
}
#homeBox{
  background:#2b2d31;
  padding:20px;
  border-radius:10px;
  width:300px;
  text-align:center;
}
#home input{width:100%;margin-bottom:8px;padding:8px}
</style>
</head>

<body>

<!-- ROOMS -->
<div id="rooms">
  <h3>Huoneet</h3>
  <div class="room" onclick="join('yleinen')"># yleinen</div>
  <div class="room" onclick="join('pelit')"># pelit</div>
</div>

<!-- MAIN -->
<div id="main">
  <div id="top">
    <span id="back">â¬…</span>
    <b id="roomName"></b>
    <span style="margin-left:auto" id="toggleUsers">ðŸ‘¥</span>
  </div>

  <div id="chat"></div>
  <div id="typing"></div>

  <div id="input">
    <input id="msg" placeholder="Viesti...">
    <button onclick="send()">âž¤</button>
  </div>
</div>

<!-- USERS -->
<div id="users">
  <b>Online</b>
  <div id="userList"></div>
</div>

<!-- HOME -->
<div id="home">
  <div id="homeBox">
    <h3>Liity chattiin</h3>
    <input id="nick" placeholder="Nimi">
    <input id="roomInput" placeholder="Huone">
    <button onclick="join()">Liity</button>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  serverTimestamp, doc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "XXX",
  authDomain: "XXX",
  projectId: "XXX",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let room="", nick="", unsub=null, onlineUnsub=null;
const chat=document.getElementById("chat");
const users=document.getElementById("users");
const userList=document.getElementById("userList");

/* ===== JOIN ===== */
window.join = async (r) => {
  nick ||= nickInput.value;
  room ||= r || roomInput.value;
  if(!nick || !room) return;

  home.style.display="none";
  roomName.textContent="# "+room;
  chat.innerHTML="";

  // messages
  unsub = onSnapshot(
    collection(db,"rooms",room,"messages"),
    s=>{
      chat.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const t=m.time?.toDate?.().toLocaleTimeString()||"";
        chat.innerHTML+=
          `<div class="msg"><b>${m.user}</b>
           <span class="time">${t}</span><br>${m.text}</div>`;
      });
      chat.scrollTop=chat.scrollHeight;
    }
  );

  // online
  await setDoc(doc(db,"rooms",room,"online",nick),{at:serverTimestamp()});
  onlineUnsub = onSnapshot(
    collection(db,"rooms",room,"online"),
    s=>{
      userList.innerHTML="";
      s.forEach(d=>{
        userList.innerHTML+=`<div>ðŸŸ¢ ${d.id}</div>`;
      });
    }
  );
};

/* ===== SEND ===== */
window.send = async () => {
  if(!msg.value) return;
  await addDoc(collection(db,"rooms",room,"messages"),{
    user:nick,
    text:msg.value,
    time:serverTimestamp()
  });
  msg.value="";
};

/* ===== BACK ===== */
back.onclick = async () => {
  unsub?.(); onlineUnsub?.();
  await deleteDoc(doc(db,"rooms",room,"online",nick));
  room=""; home.style.display="flex";
};

/* ===== TOGGLE USERS ===== */
toggleUsers.onclick=()=>users.classList.toggle("hidden");

/* ===== UNLOAD ===== */
window.addEventListener("beforeunload",()=>{
  if(room&&nick)
    deleteDoc(doc(db,"rooms",room,"online",nick));
});
</script>
</body>
</html>
