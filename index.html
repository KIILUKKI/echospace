<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat â€“ Discord Style</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing:border-box; }

body {
  margin:0;
  height:100vh;
  font-family:Inter, sans-serif;
  background:#1e1f22;
  color:#dbdee1;
  display:flex;
}

/* ===== LAYOUT ===== */
#app {
  display:flex;
  width:100%;
  height:100%;
}

/* ===== SIDEBAR ===== */
#sidebar {
  width:240px;
  background:#2b2d31;
  padding:12px;
  display:flex;
  flex-direction:column;
}

#sidebar h2 {
  font-size:14px;
  margin:0 0 10px;
  color:#949ba4;
}

.room {
  padding:10px;
  border-radius:6px;
  margin-bottom:4px;
  cursor:pointer;
  transition:.15s;
}
.room:hover {
  background:#404249;
}
.room.active {
  background:#5865f2;
  color:#fff;
}

/* ===== MAIN ===== */
#main {
  flex:1;
  display:flex;
  flex-direction:column;
}

/* HEADER */
#header {
  height:48px;
  background:#313338;
  display:flex;
  align-items:center;
  padding:0 16px;
  font-weight:600;
  border-bottom:1px solid #1f2023;
}

/* CHAT */
#chat {
  flex:1;
  padding:16px;
  overflow-y:auto;
}

.message {
  margin-bottom:12px;
}
.message b {
  color:#fff;
  font-weight:600;
}
.message span {
  color:#dbdee1;
}

/* INPUT */
#inputBar {
  padding:12px;
  background:#383a40;
  border-top:1px solid #1f2023;
}

#inputBar input {
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  background:#1e1f22;
  color:#dbdee1;
  font-size:15px;
}
#inputBar input:focus {
  outline:none;
}

/* ===== HOME VIEW ===== */
#home {
  position:absolute;
  inset:0;
  background:#1e1f22;
  display:flex;
}

#homeSidebar {
  width:240px;
  background:#2b2d31;
  padding:12px;
}

#homeCenter {
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

#homeCenter input {
  width:300px;
  padding:14px;
  border-radius:8px;
  border:none;
  background:#2b2d31;
  color:#fff;
  font-size:16px;
  margin-bottom:14px;
  text-align:center;
}

#homeCenter button {
  padding:12px 28px;
  border-radius:8px;
  border:none;
  background:#5865f2;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
#homeCenter button:hover {
  background:#4752c4;
}
</style>
</head>

<body>
<div id="app">

  <!-- HOME VIEW -->
  <div id="home">
    <div id="homeSidebar">
      <h2>ROOMS</h2>
      <div id="roomList"></div>
    </div>
    <div id="homeCenter">
      <input id="nick" placeholder="Enter your username">
      <button id="createRoomBtn">Create / Join Room</button>
    </div>
  </div>

  <!-- CHAT VIEW -->
  <div id="sidebar">
    <h2>CHANNELS</h2>
    <div id="roomListChat"></div>
  </div>

  <div id="main">
    <div id="header">Select a room</div>
    <div id="chat"></div>
    <div id="inputBar">
      <input id="msg" placeholder="Message #room">
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  authDomain: "chat-fc8ef.firebaseapp.com",
  projectId: "chat-fc8ef"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let unsub = null;

const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const nickInput = document.getElementById("nick");
const roomList = document.getElementById("roomList");
const roomListChat = document.getElementById("roomListChat");
const header = document.getElementById("header");

let nick = localStorage.getItem("nick") || "";
if(nick) nickInput.value = nick;

/* ENTER SEND */
msgInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") send();
});

/* LOAD ROOMS */
async function loadRooms(){
  roomList.innerHTML="";
  roomListChat.innerHTML="";
  const snap = await getDocs(collection(db,"rooms"));
  snap.forEach(r=>{
    const el=document.createElement("div");
    el.className="room";
    el.innerText="# "+r.id;
    el.onclick=()=>joinPrompt(r.id);
    roomList.appendChild(el);

    const el2=el.cloneNode(true);
    el2.onclick=()=>joinPrompt(r.id);
    roomListChat.appendChild(el2);
  });
}
loadRooms();

/* JOIN */
async function joinPrompt(room){
  const pass=prompt("Room password");
  if(pass===null) return;
  joinRoom(room,pass);
}

async function joinRoom(room,password){
  nick = nickInput.value.trim()||"Anon";
  localStorage.setItem("nick",nick);

  const ref=doc(db,"rooms",room);
  const snap=await getDoc(ref);
  const day=24*60*60*1000;

  if(!snap.exists()){
    await setDoc(ref,{password,expires:new Date(Date.now()+day)});
  } else if(snap.data().password!==password){
    alert("Wrong password"); return;
  }

  document.getElementById("home").style.display="none";
  currentRoom=room;
  header.innerText="# "+room;

  if(unsub) unsub();
  const q=query(collection(db,"rooms",room,"messages"),orderBy("time"));
  unsub=onSnapshot(q,s=>{
    chat.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      chat.innerHTML+=`
        <div class="message">
          <b>${m.name}</b> <span>${m.text}</span>
        </div>`;
    });
    chat.scrollTop=chat.scrollHeight;
  });
}

/* SEND */
async function send(){
  const text=msgInput.value.trim();
  if(!text) return;

  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    name:nick,
    text,
    time:serverTimestamp()
  });
  msgInput.value="";
}

/* CREATE */
document.getElementById("createRoomBtn").onclick=()=>{
  const room=prompt("Room name");
  if(!room) return;
  joinPrompt(room);
};
</script>
</body>
</html>
