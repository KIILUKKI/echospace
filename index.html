<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;font-family:Inter,sans-serif;background:#0b0f14;color:#e6edf3}
#app{width:100%;height:100%;position:relative}

/* LOGIN */
#login{
position:absolute;inset:0;
display:flex;flex-direction:column;
justify-content:center;align-items:center;
gap:12px;background:#0b0f14;z-index:10
}
#login input{
width:260px;padding:14px;
border-radius:10px;border:none;
background:#21262d;color:#fff
}
#login button{
padding:14px 28px;border-radius:12px;
background:#58a6ff;color:#000;
border:none;font-weight:600;cursor:pointer
}

/* HOME */
#home{position:absolute;inset:0;display:none;background:#0b0f14}
#homeLeft{
width:260px;height:100%;
background:#161b22;padding:14px;
overflow-y:auto;border-right:1px solid #0d1117
}
.room{
padding:10px 12px;border-radius:8px;
background:#21262d;margin-bottom:8px;
cursor:pointer
}
.room:hover{background:#58a6ff;color:#000}
#homeCenter{
flex:1;display:flex;flex-direction:column;
justify-content:center;align-items:center
}
#nickRow{display:flex;gap:12px;width:320px;margin-bottom:20px}
#nick{flex:1;padding:12px;border-radius:10px;border:none;background:#21262d;color:#fff}
#nickColor{width:42px;height:42px;border:none}
#createRoom{
padding:14px 28px;border-radius:12px;
background:#58a6ff;color:#000;
border:none;font-weight:600;cursor:pointer
}

/* MAIN */
#main{
display:none;
height:100%;
flex-direction:column
}
#header{
height:52px;background:#161b22;
display:flex;align-items:center;
padding:0 14px;border-bottom:1px solid #0d1117
}
#header button{
background:none;border:none;color:#fff;
font-size:18px;cursor:pointer;margin-right:10px
}

/* CHAT */
#chat{
flex:1;
padding:16px;
overflow-y:auto;
display:flex;
flex-direction:column;
gap:10px
}
.message{
max-width:70%;
padding:10px 14px;
border-radius:14px;
background:#161b22;
word-wrap:break-word
}
.message.me{
align-self:flex-end;
background:#58a6ff;
color:#000
}
.message b{
font-weight:600
}
#msg{
padding:14px;
width:100%;
border:none;
background:#161b22;
color:#fff
}
</style>
</head>

<body>
<div id="app">

<!-- LOGIN -->
<div id="login">
<h2>Login</h2>
<input id="loginNick" placeholder="Username">
<input id="loginPass" type="password" placeholder="Password">
<button id="loginBtn">Login / Register</button>
</div>

<!-- HOME -->
<div id="home">
<div id="homeLeft">
<h2>Rooms</h2>
<div id="roomList"></div>
</div>
<div id="homeCenter">
<div id="nickRow">
<input id="nick" placeholder="Username">
<input type="color" id="nickColor" value="#58a6ff">
</div>
<button id="createRoom">Create / Join Room</button>
</div>
</div>

<!-- MAIN -->
<div id="main">
<div id="header">
<button id="back">‚Üê</button>
<span id="roomName"></span>
</div>
<div id="chat"></div>
<input id="msg" placeholder="Message...">
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore, doc, getDoc, setDoc, collection,
addDoc, getDocs, query, orderBy,
onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
projectId:"chat-fc8ef"
});
const db = getFirestore(app);

/* DOM */
const login=document.getElementById("login");
const home=document.getElementById("home");
const main=document.getElementById("main");
const loginNick=document.getElementById("loginNick");
const loginPass=document.getElementById("loginPass");
const loginBtn=document.getElementById("loginBtn");
const roomList=document.getElementById("roomList");
const chat=document.getElementById("chat");
const msg=document.getElementById("msg");
const nickInput=document.getElementById("nick");
const nickColorInput=document.getElementById("nickColor");
const createRoom=document.getElementById("createRoom");
const back=document.getElementById("back");
const roomName=document.getElementById("roomName");

let nick="", room="";

/* LOGIN */
loginBtn.onclick=()=>{
const n=loginNick.value.trim();
const p=loginPass.value;
if(!n||!p) return alert("Fill fields");

const users=JSON.parse(localStorage.getItem("users")||"{}");

if(users[n]){
if(users[n]!==p) return alert("Wrong password");
}else{
users[n]=p;
localStorage.setItem("users",JSON.stringify(users));
}

nick=n;
nickInput.value=n;
login.style.display="none";
home.style.display="flex";
loadRooms();
};

/* ROOMS */
async function loadRooms(){
roomList.innerHTML="";
const s=await getDocs(collection(db,"rooms"));
s.forEach(r=>{
const d=document.createElement("div");
d.className="room";
d.textContent="# "+r.id;
d.onclick=()=>joinRoom(r.id);
roomList.appendChild(d);
});
}

createRoom.onclick=async()=>{
const r=prompt("Room name");
if(!r) return;
const p=prompt("Password (optional)")||"";

const ref=doc(db,"rooms",r);
if(!(await getDoc(ref)).exists()){
await setDoc(ref,{password:p,created:serverTimestamp()});
}
joinRoom(r);
};

async function joinRoom(r){
const ref=doc(db,"rooms",r);
const snap=await getDoc(ref);
if(!snap.exists()) return alert("Room doesn't exist");

const pass=prompt("Password");
if(pass!==snap.data().password) return alert("Wrong password");

home.style.display="none";
main.style.display="flex";
room=r;
roomName.textContent="# "+r;

onSnapshot(
query(collection(db,"rooms",room,"messages"),orderBy("time")),
snap=>{
chat.innerHTML="";
snap.forEach(d=>{
const m=d.data();
const div=document.createElement("div");
div.className="message"+(m.name===nick?" me":"");
div.innerHTML=`<b style="color:${m.color}">${m.name}</b><br>${m.text}`;
chat.appendChild(div);
});
chat.scrollTop=chat.scrollHeight;
});
}

/* SEND */
msg.addEventListener("keydown",async e=>{
if(e.key!=="Enter")return;
const text=msg.value.trim();
msg.value="";
if(!text)return;

await addDoc(collection(db,"rooms",room,"messages"),{
name:nick,
text,
color:nickColorInput.value,
time:serverTimestamp()
});
});

back.onclick=()=>location.reload();
</script>
</body>
</html>
