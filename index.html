<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Chat - Korjattu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f14;
    --panel:#161b22;
    --muted:#8b949e;
    --accent:#58a6ff;
    --card:#21262d;
    --text:#e6edf3;
    --lobby-width:260px;
    --drawer-duration: 200ms;
    --drawer-ease: cubic-bezier(.16,.84,.24,1);
    --guest-gray: #9aa0a6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  #app{width:100%;height:100%;position:relative;overflow:hidden}

/* SETTINGS GEAR (top-right) */
#settingsBtn{position:fixed;top:12px;right:12px;background:transparent;border:0;color:var(--text);font-size:20px;padding:10px;border-radius:10px;cursor:pointer;z-index:90}
.settings-menu{position:fixed;top:52px;right:12px;background:var(--panel);border:1px solid #0d1117;padding:8px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:none;z-index:91}
.settings-menu.show{display:block}
.settings-menu button{display:block;width:100%;padding:8px 12px;background:transparent;border:0;color:var(--text);text-align:left;border-radius:8px;cursor:pointer}
.settings-menu button:hover{background:rgba(255,255,255,0.03)}

/* PROFILE CARD */
.profile-card{position:fixed;top:56px;right:12px;background:var(--panel);border:1px solid #0d1117;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:none;z-index:92;width:220px}
.profile-card.show{display:block}
.profile-card .row{display:flex;justify-content:space-between;margin-bottom:6px}

/* CONTEXT MENU */
.context-menu{position:fixed;background:var(--panel);border:1px solid #0d1117;padding:6px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.6);display:none;z-index:200}
.context-menu button{display:block;background:transparent;border:0;color:var(--text);padding:10px 12px;text-align:left;width:160px;border-radius:6px;cursor:pointer}
.context-menu button:hover{background:rgba(255,255,255,0.03)}

/* LOGIN */
#login{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;background:var(--bg);z-index:30;padding:20px;}
#login input{padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text);width:100%;max-width:360px}
#login button{padding:12px 18px;border:none;border-radius:10px;background:var(--accent);color:#000;font-weight:700;cursor:pointer;max-width:360px;width:100%}
#login .small{background:transparent;border:1px solid #333;padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}

/* APP LAYOUT */
#home,#main{position:absolute;inset:0;display:none}
#home{display:flex;flex-direction:row}

/* Lobby (left) */
#homeLeft{width:var(--lobby-width);min-width:120px;background:var(--panel);padding:12px;border-right:1px solid #0d1117;height:100%;overflow:auto;transition:width 200ms ease,transform 220ms cubic-bezier(.2,.9,.3,1);position:relative;}
#homeLeft.collapsed{width:40px;padding:8px}
#lobbyHeader{display:flex;align-items:center;gap:8px;margin-bottom:10px}
#lobbyTitle{flex:1;font-weight:700}
.room{padding:10px 12px;border-radius:10px;background:var(--card);margin-bottom:8px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.room:hover{background:var(--accent);color:#000}

/* lobby controls */
#lobbyControls{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.iconbtn{background:transparent;border:0;color:var(--text);padding:6px;border-radius:8px;cursor:pointer}
.iconbtn:active{transform:scale(0.98)}
#lobbySizeBtn{font-weight:700;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03)}

/* center */
#homeCenter{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;padding:18px}
#nickRow{display:flex;gap:12px;width:100%;max-width:420px;align-items:center;margin-bottom:20px}
#nick{flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)}
#nick[readonly]{opacity:0.7}
#nickColorWrapper{width:42px;height:42px;position:relative}
#nickColorCircle{width:100%;height:100%;border-radius:50%;border:2px solid #fff;cursor:pointer}
.createRoom{padding:14px 28px;border-radius:12px;background:var(--accent);color:#000;border:none;font-weight:700;cursor:pointer}

/* MAIN chat */
#main{display:flex;flex-direction:column}
#header{height:56px;background:var(--panel);display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #0d1117}
#header .left{display:flex;align-items:center;gap:8px}
#roomName{font-weight:700}
#chatWrapper{display:flex;flex:1;overflow:hidden;min-height:0;position:relative}
#chatSidebar{width:var(--lobby-width);background:var(--panel);border-right:1px solid #0d1117;padding:8px;overflow:auto;transition:width 200ms ease;box-sizing:border-box;}
#chatSidebar.collapsed{width:40px;padding:6px}
#chatWrapperMain{flex:1;display:flex;flex-direction:column;min-height:0;position:relative}
#chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,transparent, rgba(255,255,255,0.01));transition:padding-bottom 120ms ease}
.message{display:flex;gap:10px;align-items:flex-start}
.avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000}
.msg{background:var(--panel);padding:10px 14px;border-radius:12px;position:relative;max-width:70%}
.msg-text{white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;}
.time{font-size:11px;color:var(--muted);margin-left:6px}
.reply-btn{position:absolute;right:8px;top:8px;font-size:12px;color:var(--muted);cursor:pointer;opacity:0}
.msg:hover .reply-btn{opacity:1}
.reply-preview{background:rgba(255,255,255,0.02);border-left:3px solid var(--accent);padding:6px;font-size:13px;margin-bottom:8px;border-radius:6px}

/* typing indicator (between chat and input) */
#typingIndicator{padding:6px 12px;color:var(--muted);font-size:13px;min-height:18px}

/* reply box is positioned above the input bar to avoid layout jumps */
#replyBox{display:none;background:var(--card);padding:8px 14px;font-size:13px;color:var(--text);position:absolute;left:12px;right:12px;bottom:72px;border-radius:10px;z-index:85;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
#inputBar{padding:12px;background:var(--panel);border-top:1px solid #0d1117;display:flex;gap:8px;align-items:center;position:relative;z-index:80}
#msg{flex:1;padding:12px;border-radius:10px;border:none;background:var(--card);color:var(--text)}
#emojiPicker{display:none;flex-wrap:wrap;gap:6px;padding:8px;background:var(--card);border-radius:8px;position:absolute;bottom:72px;left:12px;max-width:320px;max-height:300px;overflow:auto}
#emojiPicker .tabs{display:flex;gap:6px;margin-bottom:8px}
#emojiPicker .tabbtn{padding:6px 8px;border-radius:8px;border:none;background:transparent;color:var(--text);cursor:pointer}
#emojiPicker .tabbtn.active{background:rgba(255,255,255,0.03)}
#emojiPicker div.emoji{cursor:pointer;font-size:18px}

/* mobile specifics */
.mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:40;display:none;transition:background var(--drawer-duration) var(--drawer-ease)}
.mobile-overlay.show{display:block;background:rgba(0,0,0,0.45)}
.mobile-lobby-drawer{position:fixed;left:0;top:0;height:100%;width:80%;max-width:340px;background:var(--panel);z-index:50;padding:12px;transform:translateX(-110%);transition:transform var(--drawer-duration) var(--drawer-ease),opacity calc(var(--drawer-duration) * 0.9) var(--drawer-ease);opacity:0;will-change:transform}
.mobile-lobby-drawer.show{transform:translateX(0);opacity:1}
#openLobbyBtn{position:fixed;left:12px;bottom:12px;background:var(--accent);border:none;padding:12px;border-radius:999px;z-index:60;font-weight:800;color:#000;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.5)}

/* collapsed small labels */
.collapsed .label-text{display:none}
.collapsed .room{padding:8px;border-radius:8px;text-align:center}

/* responsive */
@media (max-width:900px){:root{--lobby-width:220px}}
@media (max-width:768px){
#home{flex-direction:column}
#homeLeft{display:none}
#chatSidebar{display:none}
#header{padding:10px}
#nickRow{max-width:100%}
.reply-btn{display:none}
}

.fade{transition:opacity 180ms ease,transform 180ms ease}
button, .iconbtn{outline: none}

/* scroll to bottom button centered */
#scrollBottomBtn{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:var(--accent);border:none;padding:10px;border-radius:999px;z-index:99;font-weight:800;color:#000;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.4);display:none}

/* simple tooltip for seen receipts */
.tooltip{position:fixed;padding:6px 8px;background:var(--panel);border:1px solid #0d1117;border-radius:8px;font-size:13px;color:var(--muted);z-index:120;display:none}

/* custom thin scrollbars for desktop */
#chat::-webkit-scrollbar, #homeLeft::-webkit-scrollbar, #chatSidebar::-webkit-scrollbar{height:8px;width:8px}
#chat::-webkit-scrollbar-thumb, #homeLeft::-webkit-scrollbar-thumb, #chatSidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:999px}
#chat, #homeLeft, #chatSidebar{scrollbar-color: rgba(255,255,255,0.06) transparent;scrollbar-width:thin}

</style>
</head>
<body>
<div id="app">

  <!-- SETTINGS GEAR -->
  <button id="settingsBtn" title="Settings">‚öôÔ∏è</button>
  <div id="settingsMenu" class="settings-menu" aria-hidden="true">
    <button id="settingsLogout">Logout</button>
    <button id="settingsDelete">Delete user</button>
  </div>

  <!-- PROFILE CARD -->
  <div id="profileCard" class="profile-card" aria-hidden="true">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <div id="profileAvatar" style="width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;background:var(--guest-gray)"></div>
      <div>
        <div id="profileName" style="font-weight:700"></div>
        <div id="profileJoined" style="font-size:13px;color:var(--muted)"></div>
      </div>
    </div>
    <div class="row"><div>Color</div><div id="profileColor"></div></div>
  </div>

  <!-- CONTEXT MENU -->
  <div id="contextMenu" class="context-menu" aria-hidden="true"></div>

  <!-- LOGIN -->
  <div id="login" aria-hidden="false">
    <input id="loginUser" placeholder="Username" autocomplete="username">
    <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn">Login / Register</button>
    <button id="demoBtn" class="small">Continue as Guest</button>
  </div>

  <!-- HOME -->
  <div id="home">
    <aside id="homeLeft" aria-label="Lobby">
      <div id="lobbyHeader">
        <div id="lobbyTitle">Rooms</div>
        <div id="lobbyControls">
          <button id="lobbyToggle" class="iconbtn" title="Collapse/Expand lobby">‚óÄ</button>
          <button id="lobbySizeBtn" class="iconbtn" title="Change lobby size">A</button>
        </div>
      </div>
      <div id="roomList"></div>
    </aside>

    <main id="homeCenter">
      <div id="nickRow">
        <input id="nick" placeholder="Nickname (saved)">
        <div id="nickColorWrapper">
          <div id="nickColorCircle" title="Color"></div>
          <input type="color" id="nickColor" value="#58a6ff" style="position:absolute;opacity:0;left:0;top:0;width:100%;height:100%;">
        </div>
      </div>
      <button id="createRoom" class="createRoom">Create / Join Room</button>
      <div style="margin-top:16px;color:var(--muted);font-size:13px;text-align:center;max-width:420px">
        Swipe from the edge to open the room drawer on mobile. Drawer open/close is smooth and fast.
      </div>
    </main>

  </div>

  <!-- MAIN CHAT -->
  <div id="main" aria-hidden="true">
    <div id="header">
      <div class="left">
        <button id="back" class="iconbtn" title="Back">‚Üê</button>
        <div id="roomName">#room</div>
      </div>
      <div style="flex:1"></div>
      <div style="display:flex;gap:8px;align-items:center"></div>
    </div>

    <div id="chatWrapper">
      <aside id="chatSidebar" aria-label="Chat sidebar">
        <div id="chatRoomsHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Rooms</div>
          <button id="sidebarToggle" class="iconbtn" title="Collapse">‚óÄ</button>
        </div>
        <div id="roomListSidebar"></div>
      </aside>

      <div id="chatWrapperMain">
        <div id="chat"></div>

        <!-- TYPING INDICATOR: appears between chat and input -->
        <div id="typingIndicator" aria-live="polite"></div>

        <div id="replyBox"></div>
        <div id="inputBar">
          <button id="emojiBtn">üòä</button>
          <input id="msg" placeholder="Message... (/clear /delete)" autocomplete="off">
          <div id="emojiPicker"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Mobile overlay and drawer -->
  <div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>
  <div id="mobileDrawer" class="mobile-lobby-drawer" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">Rooms</div>
      <button id="closeDrawer" class="iconbtn">‚úï</button>
    </div>
    <div id="roomListMobile"></div>
  </div>

  <!-- Blue three-line button (mobile) -->
  <button id="openLobbyBtn" title="Open lobby">‚ò∞</button>

  <!-- Floating scroll to bottom button (now centered) -->
  <button id="scrollBottomBtn" title="Scroll to bottom">‚Üì</button>

  <!-- tooltip element -->
  <div id="tooltip" class="tooltip" aria-hidden="true"></div>

</div>

<script type="module">
/* Korjattu: typing indicator, komennot, ja oikea klikkaus -> dropdown menu. */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase init - vaihda oma config jos tarv */
const firebaseConfig = {
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM refs */
const login = document.getElementById('login');
const home = document.getElementById('home');
const main = document.getElementById('main');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');

const roomList = document.getElementById('roomList');
const roomListSidebar = document.getElementById('roomListSidebar');
const roomListMobile = document.getElementById('roomListMobile');

const createRoomBtn = document.getElementById('createRoom');
const nickInput = document.getElementById('nick');
const nickColorInput = document.getElementById('nickColor');
const nickColorCircle = document.getElementById('nickColorCircle');

const lobby = document.getElementById('homeLeft');
const lobbyToggle = document.getElementById('lobbyToggle');
const lobbySizeBtn = document.getElementById('lobbySizeBtn');

const chatSidebar = document.getElementById('chatSidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

const openLobbyBtn = document.getElementById('openLobbyBtn');
const mobileOverlay = document.getElementById('mobileOverlay');
const mobileDrawer = document.getElementById('mobileDrawer');
const closeDrawer = document.getElementById('closeDrawer');

const chat = document.getElementById('chat');
const chatWrapperMain = document.getElementById('chatWrapperMain');
const msg = document.getElementById('msg');
const replyBox = document.getElementById('replyBox');
const roomName = document.getElementById('roomName');
const emojiPicker = document.getElementById('emojiPicker');
const emojiBtn = document.getElementById('emojiBtn');
const typingIndicator = document.getElementById('typingIndicator');
const back = document.getElementById('back');

const settingsBtn = document.getElementById('settingsBtn');
const settingsMenu = document.getElementById('settingsMenu');
const settingsLogout = document.getElementById('settingsLogout');
const settingsDelete = document.getElementById('settingsDelete');

const profileCard = document.getElementById('profileCard');
const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const profileJoined = document.getElementById('profileJoined');
const profileColor = document.getElementById('profileColor');

const scrollBottomBtn = document.getElementById('scrollBottomBtn');
const tooltip = document.getElementById('tooltip');
const contextMenu = document.getElementById('contextMenu');

let users = JSON.parse(localStorage.getItem('users')||'{}');
let nick = localStorage.getItem('nick') || '';
let nickColor = localStorage.getItem('nickColor')||'#58a6ff';
let room = '';
let replyTo = null;
let typingTimeout = null;
let messagesUnsub = null;
let typingUnsub = null;

const userCache = new Map();

const isTouch = matchMedia('(pointer:coarse)').matches;
const isMobile = /Mobi|Android|iPhone|iPad|Windows Phone/.test(navigator.userAgent) || isTouch;

nickColorInput.value = nickColor;
nickColorCircle.style.background = nickColor;
nickInput.value = nick || '';

function enforceDesktopLobby(){
  if(!isMobile){
    lobby.style.display = 'block';
    chatSidebar.style.display = 'block';
    if(lobbyToggle) lobbyToggle.style.display = 'none';
    if(sidebarToggle) sidebarToggle.style.display = 'none';
  } else {
    lobby.style.display = 'none';
    chatSidebar.style.display = 'none';
  }
}
enforceDesktopLobby();

function showHome(){ login.style.display='none'; home.style.display='flex'; main.style.display='none'; updateOpenLobbyBtnVisibility(); updateNickEditable(); }
function showLogin(){ login.style.display='flex'; home.style.display='none'; main.style.display='none'; localStorage.removeItem('session'); updateOpenLobbyBtnVisibility(); updateNickEditable(); }
function showMain(){ login.style.display='none'; home.style.display='none'; main.style.display='flex'; updateOpenLobbyBtnVisibility(); updateNickEditable(); }

if(localStorage.getItem('session')) showHome(); else showLogin();

function updateNickEditable(){
  const session = localStorage.getItem('session') || '';
  if(session.startsWith('Guest')){
    nickInput.readOnly = true; nickColorInput.disabled = true; nickColorCircle.style.pointerEvents = 'none'; nickInput.title = "Guest name cannot be changed";
    nickColorInput.value = getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim() || '#9aa0a6';
    nickColorCircle.style.background = nickColorInput.value;
  } else {
    nickInput.readOnly = false; nickColorInput.disabled = false; nickColorCircle.style.pointerEvents = 'auto'; nickInput.title = "";
    nickColorInput.value = localStorage.getItem('nickColor') || '#58a6ff'; nickColorCircle.style.background = nickColorInput.value;
  }
}

/* LOGIN & save user color */
loginBtn.onclick = async () => {
  const u = loginUser.value.trim();
  const p = loginPass.value;
  if(!u || !p) return alert('T√§yt√§ molemmat kent√§t');
  if(users[u] && users[u] !== p) return alert('V√§√§r√§ salasana');
  users[u] = p; localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('session',u); nick = u; localStorage.setItem('nick', u);
  // save color to users collection
  const colorToSave = localStorage.getItem('nickColor') || '#58a6ff';
  try{ await setDoc(doc(db,'users',u), { color: colorToSave, joined: serverTimestamp() }, { merge: true }); userCache.set(u,{color:colorToSave}); }catch(e){}
  showHome();
};
demoBtn.onclick = async ()=>{
  const guest = 'Guest' + Math.floor(Math.random()*10000);
  localStorage.setItem('session', guest); nick = guest; localStorage.setItem('nick', guest);
  const guestColor = getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim() || '#9aa0a6';
  localStorage.setItem('nickColor', guestColor);
  try{ await setDoc(doc(db,'users',guest), { color: guestColor, joined: serverTimestamp() }, { merge: true }); userCache.set(guest,{color:guestColor}); }catch(e){}
  showHome();
};

/* settings */
settingsBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const open = settingsMenu.classList.toggle('show'); settingsMenu.setAttribute('aria-hidden', !open); profileCard.classList.remove('show'); profileCard.setAttribute('aria-hidden','true'); });
document.addEventListener('click', ()=>{ if(settingsMenu.classList.contains('show')){ settingsMenu.classList.remove('show'); settingsMenu.setAttribute('aria-hidden','true'); } if(profileCard.classList.contains('show')){ profileCard.classList.remove('show'); profileCard.setAttribute('aria-hidden','true'); } hideContextMenu(); });

settingsLogout.addEventListener('click', ()=>{ settingsMenu.classList.remove('show'); localStorage.removeItem('session'); showLogin(); });
settingsDelete.addEventListener('click', async ()=>{ settingsMenu.classList.remove('show'); const session = localStorage.getItem('session'); if(!session){ alert('No logged-in user'); return; } if(session.startsWith('Guest')){ alert('Guest account cannot be deleted.'); return; } if(!confirm(`Delete user "${session}" and its saved credentials? This cannot be undone.`)) return; try{ users = JSON.parse(localStorage.getItem('users')||'{}'); delete users[session]; localStorage.setItem('users', JSON.stringify(users)); await deleteDoc(doc(db,'users',session)).catch(()=>{}); }catch(e){} localStorage.removeItem('session'); localStorage.removeItem('nick'); showLogin(); });

function showProfileCardFor(name, color, joined, anchorEl){ profileAvatar.textContent = name?.[0] || '?'; profileAvatar.style.background = color || getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim(); profileName.textContent = name; profileColor.textContent = color || ''; profileJoined.textContent = joined ? `Joined: ${new Date(joined).toLocaleDateString()}` : ''; if(anchorEl){ const r = anchorEl.getBoundingClientRect(); profileCard.style.top = (r.bottom + 8) + 'px'; profileCard.style.right = Math.max(12, window.innerWidth - r.right) + 'px'; } profileCard.classList.add('show'); profileCard.setAttribute('aria-hidden','false'); }

nickColorCircle.addEventListener('click', ()=> { if(nickColorInput.disabled) return; nickColorInput.click(); });
nickColorInput.addEventListener('input', async ()=>{ nickColorCircle.style.background = nickColorInput.value; localStorage.setItem('nickColor', nickColorInput.value); const session = localStorage.getItem('session') || ''; if(session && !session.startsWith('Guest')){ try{ await setDoc(doc(db,'users',session), { color: nickColorInput.value }, { merge: true }); userCache.set(session,{color:nickColorInput.value}); }catch(e){} } });

/* ROOM LIST */
async function loadRooms(){ roomList.innerHTML=''; roomListSidebar.innerHTML=''; roomListMobile.innerHTML=''; try{ const s = await getDocs(collection(db,'rooms')); s.forEach(r=> renderRoomEntry(r.id)); }catch(e){ console.error('loadRooms',e);} }
function renderRoomEntry(id){ const createEl=(container)=>{ const d=document.createElement('div'); d.className='room'; d.textContent='# '+id; d.onclick=()=> joinRoom(id); container.appendChild(d); }; createEl(roomList); createEl(roomListSidebar); createEl(roomListMobile); }

createRoomBtn.onclick = async ()=>{ const r = prompt('Room name'); if(!r) return; const p = prompt('Password (optional)'); const ref = doc(db,'rooms',r); const snap = await getDoc(ref); if(!snap.exists()) await setDoc(ref,{password:p||'',created:serverTimestamp()}); joinRoom(r); };

/* JOIN ROOM */
async function joinRoom(r){ const ref=doc(db,'rooms',r); const snap=await getDoc(ref); if(!snap.exists()) return alert('Room not found'); const pass = prompt('Password'); if(pass !== snap.data().password) return alert('Incorrect room password'); nick = nickInput.value || ('Anon'+Math.floor(Math.random()*1000)); const session = localStorage.getItem('session') || ''; if(session && session.startsWith('Guest')){ nickColor = getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim() || '#9aa0a6'; } else { nickColor = nickColorInput.value || localStorage.getItem('nickColor') || '#58a6ff'; } localStorage.setItem('nick', nick); localStorage.setItem('nickColor', nickColor); // close mobile drawer smoothly if open
  const durationMs = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--drawer-duration')) || 200; const drawerOpen = mobileDrawer.classList.contains('show'); if(isMobile && drawerOpen){ mobileDrawer.classList.remove('show'); mobileOverlay.classList.remove('show'); setTimeout(()=>{ mobileOverlay.style.display='none'; mobileDrawer.style.display='none'; enterRoom(r); updateOpenLobbyBtnVisibility(); }, durationMs+20); } else enterRoom(r);
}

/* ENTER ROOM with incremental rendering */
async function enterRoom(r){ showMain(); room = r; roomName.textContent = '# '+r; chat.innerHTML=''; if(messagesUnsub) messagesUnsub(); if(typingUnsub) typingUnsub();
  const msgsQuery = query(collection(db,'rooms',room,'messages'), orderBy('time'));
  messagesUnsub = onSnapshot(msgsQuery, snap=>{
    const shouldScroll = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 160;
    snap.docChanges().forEach(change=>{
      const d = change.doc; const m = d.data(); if(change.type==='added'){ renderMessage(d.id, m); // mark seen
          const localNick = localStorage.getItem('nick') || nick; if(localNick){ setDoc(doc(db, 'rooms', room, 'messages', d.id, 'seen', localNick), {name: localNick, t: Date.now()}).catch(()=>{}); }
        }
      else if(change.type==='modified') updateMessage(d.id, m);
      else if(change.type==='removed') removeMessage(d.id);
    });
    if(shouldScroll) scrollChatToBottom();
  });

  // use client timestamps for typing to avoid serverTimestamp latency
  typingUnsub = onSnapshot(collection(db,'rooms',room,'typing'), snap=>{
    const now = Date.now(); const usersTyping = [];
    snap.forEach(d=>{ const t = d.data().t; if(d.id !== (localStorage.getItem('nick')||nick) && t && now - t < 2500) usersTyping.push(d.id); });
    typingIndicator.textContent = usersTyping.length ? usersTyping.join(', ') + ' kirjoittaa...' : '';
  });
}

/* MESSAGE RENDER HELPERS */
function makeMessageElement(id,m){ const el=document.createElement('div'); el.className='message'; el.dataset.msgid=id; el.dataset.owner=m.name; const replyHtml = m.reply?`<div class="reply-preview"><b>${escapeHtml(m.reply.name)}</b>: ${escapeHtml(m.reply.text)}</div>`:''; const safeTextHtml = linkify(escapeHtml(m.text||'')); el.innerHTML = `
  <div class="avatar" style="background:${m.color||getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim()}">${escapeHtml((m.name||'?')[0]||'?')}</div>
  <div class="msg">
    ${replyHtml}
    <b class="msg-sender" style="color:${m.color||'#999'};cursor:pointer">${escapeHtml(m.name)}</b>
    <span class="time">${m.time?.toMillis? new Date(m.time.toMillis()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}</span>
    <div class="msg-text">${safeTextHtml}</div>
    <div class="reply-btn" data-name="${escapeAttr(m.name)}" data-text="${escapeAttr(m.text)}">reply</div>
  </div>
`;
  // interactions
  const senderEl = el.querySelector('.msg-sender'); if(senderEl){ if(!isMobile){ senderEl.addEventListener('mouseenter', async ev=>{ ev.stopPropagation(); let joined=null; let color=m.color; try{ const cached=userCache.get(m.name); if(cached && cached.color) color=cached.color; else{ const us=await getDoc(doc(db,'users',m.name)); if(us.exists()){ const ud=us.data(); joined=ud.joined?.toMillis? new Date(ud.joined.toMillis()) : ud.joined; color = ud.color || color; userCache.set(m.name,{color}); } } }catch(e){} showProfileCardFor(m.name,color,joined,senderEl); }); senderEl.addEventListener('mouseleave', ()=>{ setTimeout(()=>{ if(document.querySelector(':hover') !== senderEl) { profileCard.classList.remove('show'); profileCard.setAttribute('aria-hidden','true'); } }, 120); }); } else { senderEl.addEventListener('click', async ev=>{ ev.stopPropagation(); let joined=null; let color=m.color; try{ const cached=userCache.get(m.name); if(cached && cached.color) color=cached.color; else{ const us=await getDoc(doc(db,'users',m.name)); if(us.exists()){ const ud=us.data(); joined=ud.joined?.toMillis? new Date(ud.joined.toMillis()) : ud.joined; color = ud.color || color; userCache.set(m.name,{color}); } } }catch(e){} showProfileCardFor(m.name,color,joined,senderEl); }); } }

  // hover tooltip
  el.addEventListener('mouseenter', async ()=>{ if(m.name === (localStorage.getItem('nick')||nick)) return; const rect = el.getBoundingClientRect(); tooltip.style.left = (rect.right + 8) + 'px'; tooltip.style.top = (rect.top) + 'px'; tooltip.textContent = 'Loading...'; tooltip.style.display = 'block'; tooltip.setAttribute('aria-hidden','false'); try{ const seenDocs = await getDocs(collection(db, 'rooms', room, 'messages', id, 'seen')); const names=[]; seenDocs.forEach(sd=> names.push(sd.data().name)); tooltip.textContent = names.length ? ('Seen by: ' + names.join(', ')) : 'No one has seen this yet'; }catch(e){ tooltip.textContent = '‚Äî'; } });
  el.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; tooltip.setAttribute('aria-hidden','true'); });

  // right-click -> context menu
  el.addEventListener('contextmenu', ev=>{ ev.preventDefault(); const owner = m.name; const current = localStorage.getItem('nick') || nick; const options=[];
    if(owner === current){ options.push({label:'Edit', action:()=> editMessageInline(id,m)}); options.push({label:'Delete', action:()=> deleteMessage(id)}); } else { options.push({label:'Reply', action:()=> { replyTo = { name:m.name, text:m.text }; replyBox.style.display='block'; replyBox.innerHTML = `Replying to <b>${escapeHtml(replyTo.name)}</b> <button id="cancelReply" style="margin-left:8px">x</button>`; const btn=document.getElementById('cancelReply'); if(btn) btn.onclick = cancelReply; } }); options.push({label:'Copy', action:()=> navigator.clipboard?.writeText(m.text||'')}); }
    showContextMenu(ev.clientX, ev.clientY, options);
  });

  // mobile interactions & reply button
  el.querySelectorAll('.reply-btn').forEach(b=> b.addEventListener('click', ()=>{ replyTo = { name: b.dataset.name, text: b.dataset.text }; replyBox.style.display='block'; replyBox.innerHTML = `Replying to <b>${escapeHtml(replyTo.name)}</b> <button id="cancelReply" style="margin-left:8px">x</button>`; const btn=document.getElementById('cancelReply'); if(btn) btn.onclick = cancelReply; }));

  attachMobileInteractions(el,id,m);
  return el;
}

function renderMessage(id,m){ if(chat.querySelector(`[data-msgid="${id}"]`)) return; const el = makeMessageElement(id,m); chat.appendChild(el); }
function updateMessage(id,m){ const el = chat.querySelector(`[data-msgid="${id}"]`); if(!el){ renderMessage(id,m); return; } const avatar = el.querySelector('.avatar'); const sender = el.querySelector('.msg-sender'); const time = el.querySelector('.time'); const msgText = el.querySelector('.msg-text'); if(avatar) avatar.style.background = m.color || getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim(); if(sender) { sender.textContent = m.name; sender.style.color = m.color || '#999'; } if(time) time.textContent = m.time?.toMillis ? new Date(m.time.toMillis()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''; if(msgText) msgText.innerHTML = linkify(escapeHtml(m.text||'')); const replyPrev = el.querySelector('.reply-preview'); if(replyPrev && !m.reply) replyPrev.remove(); else if(!replyPrev && m.reply) el.querySelector('.msg').insertAdjacentHTML('afterbegin', `<div class="reply-preview"><b>${escapeHtml(m.reply.name)}</b>: ${escapeHtml(m.reply.text)}</div>`); }
function removeMessage(id){ const el = chat.querySelector(`[data-msgid="${id}"]`); if(el) el.remove(); }

/* context menu functions */
function showContextMenu(x,y,options){ contextMenu.innerHTML=''; options.forEach(opt=>{ const btn=document.createElement('button'); btn.textContent = opt.label; btn.onclick = ()=>{ hideContextMenu(); try{ opt.action(); }catch(e){ console.error(e);} }; contextMenu.appendChild(btn); }); contextMenu.style.left = x + 'px'; contextMenu.style.top = y + 'px'; contextMenu.style.display = 'block'; contextMenu.setAttribute('aria-hidden','false'); }
function hideContextMenu(){ contextMenu.style.display = 'none'; contextMenu.setAttribute('aria-hidden','true'); }

/* edit inline (prompt-based, could be replaced with inline editor) */
async function editMessageInline(msgId, oldData){ const newText = prompt('Edit message', oldData.text); if(newText == null) return; try{ await updateDoc(doc(db,'rooms',room,'messages',msgId), { text: newText }); }catch(e){ console.error('edit err', e); } }
async function deleteMessage(msgId){ if(!confirm('Delete this message?')) return; try{ // delete seen subdocs
    const seenSnap = await getDocs(collection(db,'rooms',room,'messages',msgId,'seen')); for(const sd of seenSnap.docs) await deleteDoc(sd.ref).catch(()=>{}); await deleteDoc(doc(db,'rooms',room,'messages',msgId)); }catch(e){ console.error('delete msg err',e); } }

/* mobile interactions: same swipe/longpress logic as before */
function attachMobileInteractions(el,msgId,messageData){ let longPressTimer=null; let touchStartX=0; let touchStartY=0; let dragging=false; el.addEventListener('touchstart', e=>{ const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY; if(messageData.name === (localStorage.getItem('nick')||nick)){ longPressTimer = setTimeout(()=>{ const choice = prompt('Type "edit" to edit or "delete" to delete this message'); if(!choice) return; if(choice.toLowerCase().startsWith('e')){ const newText = prompt('Edit message', messageData.text); if(newText==null) return; updateDoc(doc(db,'rooms',room,'messages',msgId), {text:newText}).catch(()=>{}); } else if(choice.toLowerCase().startsWith('d')){ if(confirm('Delete this message?')) deleteDoc(doc(db,'rooms',room,'messages',msgId)).catch(()=>{}); } },650); }
    dragging=false; el.style.transition=''; }, {passive:true});
  el.addEventListener('touchmove', e=>{ const t=e.touches[0]; const dx=t.clientX-touchStartX; const dy=t.clientY-touchStartY; if(Math.abs(dy) > Math.abs(dx)){ if(longPressTimer) clearTimeout(longPressTimer); return; } if(!dragging && Math.abs(dx) > 10){ dragging=true; if(longPressTimer) clearTimeout(longPressTimer); } if(dragging){ e.preventDefault(); const capped = Math.min(Math.max(dx,0),120); el.style.transform = `translateX(${capped}px)`; el.style.willChange='transform'; el.style.transition='none'; if(capped>36){ const m = messageData; replyBox.style.display='block'; replyBox.innerHTML = `Replying to <b>${escapeHtml(m.name)}</b> <button id="cancelReply" style="margin-left:8px">x</button>`; const btn=document.getElementById('cancelReply'); if(btn) btn.onclick = cancelReply; } else if(capped <=36){ if(!replyTo) replyBox.style.display='none'; } } }, {passive:false});
  el.addEventListener('touchend', ()=>{ if(longPressTimer) clearTimeout(longPressTimer); if(el.style.transform && el.style.transform !== 'none'){ const m = el.style.transform.match(/translateX\((\d+)px\)/); const px = m ? parseInt(m[1],10) : 0; el.style.transition = 'transform 180ms ease'; if(px>60){ el.style.transform='translateX(0)'; setTimeout(()=>{ replyTo = { name: messageData.name, text: messageData.text }; replyBox.style.display='block'; replyBox.innerHTML = `Replying to <b>${escapeHtml(replyTo.name)}</b> <button id="cancelReply" style="margin-left:8px">x</button>`; const btn=document.getElementById('cancelReply'); if(btn) btn.onclick = cancelReply; },160); } else { el.style.transform='translateX(0)'; setTimeout(()=>{ if(!replyTo) replyBox.style.display='none'; },160); } } el.style.willChange=''; }); }

/* typing indicator: use client timestamp to be immediate */
msg.addEventListener('input', ()=>{
  if(!room || !nick) return;
  const localNick = localStorage.getItem('nick') || nick;
  if(msg.value.trim()===''){ deleteDoc(doc(db,'rooms',room,'typing',localNick)).catch(()=>{}); return; }
  setDoc(doc(db,'rooms',room,'typing',localNick),{t: Date.now()}).catch(()=>{});
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{ deleteDoc(doc(db,'rooms',room,'typing',localNick)).catch(()=>{}); }, 1500);
});
msg.addEventListener('blur', ()=>{ if(room && (localStorage.getItem('nick')||nick)) deleteDoc(doc(db,'rooms',room,'typing',localStorage.getItem('nick')||nick)).catch(()=>{}); });

/* reply UI */
chat.addEventListener('click', (e)=>{ const b = e.target.closest('.reply-btn'); if(!b) return; replyTo = { name: b.dataset.name, text: b.dataset.text }; replyBox.style.display='block'; replyBox.innerHTML = `Replying to <b>${escapeHtml(replyTo.name)}</b> <button id="cancelReply" style="margin-left:8px">x</button>`; document.getElementById('cancelReply').onclick = cancelReply; });
function cancelReply(){ replyTo = null; replyBox.style.display='none'; }

/* send messages + command handling BEFORE sending */
msg.addEventListener('keydown', async (e)=>{ if(e.key !== 'Enter') return; e.preventDefault(); const textRaw = msg.value.trim(); msg.value=''; if(!textRaw) return; if(!room){ alert('You are not in a room'); return; }
  // handle commands first
  if(textRaw.startsWith('/')){ await handleCommand(textRaw); return; }
  // send message
  const colorToSend = (localStorage.getItem('session') && !localStorage.getItem('session').startsWith('Guest')) ? (localStorage.getItem('nickColor') || '#58a6ff') : getComputedStyle(document.documentElement).getPropertyValue('--guest-gray').trim();
  try{ await addDoc(collection(db,'rooms',room,'messages'), { name: localStorage.getItem('nick') || nick, text: textRaw, reply: replyTo, color: colorToSend, time: serverTimestamp() }); }catch(e){ console.error('send err', e); }
  replyTo = null; replyBox.style.display='none'; });

/* command processor (robust) */
async function handleCommand(cmdText){ const parts = cmdText.split(/\s+/); const c = parts[0].toLowerCase(); if(c === '/clear'){ if(!confirm('Poistetaanko kaikki viestit t√§st√§ huoneesta?')) return; try{ const msgs = await getDocs(collection(db,'rooms',room,'messages')); for(const d of msgs.docs){ const seenSnap = await getDocs(collection(db,'rooms',room,'messages',d.id,'seen')); for(const sd of seenSnap.docs) await deleteDoc(sd.ref).catch(()=>{}); await deleteDoc(d.ref).catch(()=>{}); } }catch(e){ console.error('/clear',e); } return; } if(c === '/delete'){ if(!confirm('Poistetaanko huone ja kaikki viestit?')) return; try{ const typingDocs = await getDocs(collection(db,'rooms',room,'typing')); for(const t of typingDocs.docs) await deleteDoc(t.ref).catch(()=>{}); const msgs = await getDocs(collection(db,'rooms',room,'messages')); for(const d of msgs.docs){ try{ const seenSnap = await getDocs(collection(db,'rooms',room,'messages',d.id,'seen')); for(const sd of seenSnap.docs) await deleteDoc(sd.ref).catch(()=>{}); }catch(e){} await deleteDoc(d.ref).catch(()=>{}); } await deleteDoc(doc(db,'rooms',room)).catch(()=>{}); if(messagesUnsub) messagesUnsub(); if(typingUnsub) typingUnsub(); room=''; chat.innerHTML=''; showHome(); }catch(e){ console.error('/delete',e); } return; } // extra helpful commands
  if(c === '/roll'){ let n=1; if(parts[1]) n = Math.min(10, Math.max(1, parseInt(parts[1])||1)); const rolls=[]; for(let i=0;i<n;i++) rolls.push(Math.floor(Math.random()*6)+1); const txt = `${localStorage.getItem('nick')||nick} rolled üé≤ ${rolls.map(r=>`üé≤ ${r}`).join(n>1?' + ':'')}${n>1?` = ${rolls.reduce((a,b)=>a+b,0)}`:''}`; await addDoc(collection(db,'rooms',room,'messages'), {name:'System', text:txt, color:'#888', time: serverTimestamp()}); return; } if(c === '/coin'){ const r = Math.random() < 0.5 ? 'Heads' : 'Tails'; const txt = `${localStorage.getItem('nick')||nick} flipped a coin ‚Üí ${r}`; await addDoc(collection(db,'rooms',room,'messages'), {name:'System', text:txt, color:'#888', time: serverTimestamp()}); return; } // fallback
  await addDoc(collection(db,'rooms',room,'messages'), {name:'System', text:`Unknown command: ${cmdText}`, color:'#888', time: serverTimestamp()}); }

/* emoji picker */
const emojiList = ["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÇ","ü§£","üôÇ","üôÉ","üòâ","üòä","üòá","üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòú","ü§™","üòù","ü§ó","ü§≠","ü§´","ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè","üò£","üò•","üòÆ","üòØ","üò≤","üò™","üò´","ü•±","üò¥","üòå","üò§","üò†","üò°","ü§¨","üò¢","üò≠","ü•∫","üò≥","üò±","üò®","üò∞","üòì","üëç","üëé","üëå","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëã","üëè","üôå","üôè"];
function buildEmojiPicker(){ emojiPicker.innerHTML=''; const grid=document.createElement('div'); grid.style.display='flex'; grid.style.flexWrap='wrap'; grid.style.gap='6px'; emojiPicker.appendChild(grid); emojiList.forEach(e=>{ const d=document.createElement('div'); d.className='emoji'; d.textContent=e; d.onclick=()=>{ msg.value += e; emojiPicker.style.display='none'; msg.focus(); }; grid.appendChild(d); }); }
buildEmojiPicker(); emojiBtn.onclick = ()=> emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';

/* back */
back.onclick = ()=>{ if(messagesUnsub) messagesUnsub(); if(typingUnsub) typingUnsub(); showHome(); room=''; chat.innerHTML=''; typingIndicator.textContent=''; };

/* lobby size */
const LOBBY_SIZES = [{name:'small', width:'120px'},{name:'normal', width:'260px'},{name:'large', width:'360px'}];
let lobbySizeIndex = parseInt(localStorage.getItem('lobbySizeIndex')||'1',10); applyLobbySize();
lobbySizeBtn.addEventListener('click', ()=>{ lobbySizeIndex=(lobbySizeIndex+1)%LOBBY_SIZES.length; applyLobbySize(); localStorage.setItem('lobbySizeIndex', lobbySizeIndex); });
function applyLobbySize(){ const s=LOBBY_SIZES[lobbySizeIndex]; document.documentElement.style.setProperty('--lobby-width', s.width); lobbySizeBtn.textContent = s.name[0].toUpperCase(); if(isMobile){ const collapse = (s.name==='small'); lobby.classList.toggle('collapsed', collapse); chatSidebar.classList.toggle('collapsed', collapse); } else { lobby.classList.remove('collapsed'); chatSidebar.classList.remove('collapsed'); } }

/* Mobile drawer drag code unchanged (omitted here for brevity: kept from earlier) */
let dragging=false; let startX=0; let lastX=0; let lastT=0; let vx=0; let drawerWidth=0; const EDGE_ZONE=36; const SHORT_THRESHOLD=30; const VELOCITY_THRESHOLD=0.35; let touchStarted=false; let touchStartX=0; let touchStartY=0; let touchPotentialDrag=false;
function beginDrag(x, initiallyOpen){ dragging=true; startX=x; lastX=x; lastT=performance.now(); drawerWidth = mobileDrawer.getBoundingClientRect().width || (window.innerWidth * 0.8); mobileDrawer.style.transition='none'; mobileOverlay.style.transition='none'; if(!mobileOverlay.classList.contains('show')) mobileOverlay.style.display='block'; if(!mobileDrawer.classList.contains('show')) mobileDrawer.style.display='block'; mobileDrawer.classList.remove('show'); }
function dragMove(x){ if(!dragging) return; const dx = x - startX; const wasOpen = mobileDrawer.classList.contains('show'); let translate; if(wasOpen) translate = Math.min(0, dx); else translate = Math.max(-drawerWidth, -drawerWidth + dx); if(translate > 0) translate=0; if(translate < -drawerWidth) translate = -drawerWidth; mobileDrawer.style.transform = `translateX(${translate}px)`; const openness = 1 - (Math.abs(translate) / drawerWidth); mobileOverlay.style.background = `rgba(0,0,0,${0.45 * openness})`; mobileOverlay.style.display='block'; const now = performance.now(); const dt = now-lastT || 16; vx = (x-lastX)/dt; lastX = x; lastT = now; }
function endDrag(){ if(!dragging) return; dragging=false; const style = window.getComputedStyle(mobileDrawer); let translateX = 0; const matrix = style.transform; if(matrix && matrix !== 'none'){ try{ const m = mobileDrawer.style.transform.match(/translateX\((-?\d+(\.\d+)?)px\)/); translateX = m ? parseFloat(m[1]) : 0; }catch(e){ translateX=0; } } else { const m = mobileDrawer.style.transform.match(/translateX\((-?\d+(\.\d+)?)px\)/); translateX = m ? parseFloat(m[1]) : 0; } const wasOpen = mobileDrawer.classList.contains('show'); const openDecision = (()=>{ if(Math.abs(vx) > VELOCITY_THRESHOLD) return vx > 0; if(wasOpen) return !(Math.abs(translateX) > SHORT_THRESHOLD); else return (Math.abs(translateX) < (drawerWidth - SHORT_THRESHOLD)); })(); mobileDrawer.style.transition=''; mobileOverlay.style.transition=''; if(openDecision){ mobileDrawer.style.transform=''; mobileDrawer.classList.add('show'); mobileOverlay.classList.add('show'); updateOpenLobbyBtnVisibility(); } else { mobileDrawer.style.transform = `translateX(-${drawerWidth}px)`; mobileDrawer.classList.remove('show'); mobileOverlay.classList.remove('show'); setTimeout(()=>{ if(!mobileDrawer.classList.contains('show')){ mobileOverlay.style.display='none'; mobileDrawer.style.display='none'; updateOpenLobbyBtnVisibility(); } }, 220); } vx=0; mobileDrawer.style.willChange=''; }

document.addEventListener('touchstart', (e)=>{ if(!isMobile) return; const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY; touchStarted=true; touchPotentialDrag=false; const drawerOpen = mobileDrawer.classList.contains('show'); const isHomeVisible = home.style.display !== 'none'; if(drawerOpen || (isHomeVisible && touchStartX <= EDGE_ZONE)) touchPotentialDrag = true; }, {passive:true});

document.addEventListener('touchmove', (e)=>{ if(!isMobile || !touchStarted) return; const t=e.touches[0]; const dx = t.clientX - touchStartX; const dy = t.clientY - touchStartY; if(Math.abs(dy) > Math.abs(dx) + 8){ if(dragging) endDrag(); touchStarted=false; touchPotentialDrag=false; return; } if(!dragging){ if(touchPotentialDrag && Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)){ const drawerOpen = mobileDrawer.classList.contains('show'); beginDrag(t.clientX, drawerOpen); dragMove(t.clientX); return; } else return; } if(dragging) dragMove(t.clientX); }, {passive:true});

document.addEventListener('touchend', (e)=>{ if(!isMobile) return; if(dragging) endDrag(); touchStarted=false; touchPotentialDrag=false; });

openLobbyBtn.addEventListener('click', openMobileDrawer);
mobileOverlay.addEventListener('click', closeMobileDrawer);
closeDrawer.addEventListener('click', closeMobileDrawer);

/* keyboard handling for mobile viewport */
function onViewportResize(){ const vv = window.visualViewport; let keyboardHeight = 0; if(vv){ keyboardHeight = window.innerHeight - vv.height - (vv.offsetTop || 0); if(keyboardHeight < 0) keyboardHeight = 0; } else keyboardHeight = Math.max(0, (document._lastInnerHeight || window.innerHeight) - window.innerHeight); if(keyboardHeight > 0){ chat.style.paddingBottom = (keyboardHeight + 84) + 'px'; replyBox.style.bottom = (keyboardHeight + 84) + 'px'; setTimeout(()=> scrollChatToBottom(false), 60); } else { chat.style.paddingBottom = ''; replyBox.style.bottom = '72px'; scrollChatToBottom(); } }
window.addEventListener('resize', ()=> { document._lastInnerHeight = Math.max(document._lastInnerHeight || 0, window.innerHeight); }); if(window.visualViewport) window.visualViewport.addEventListener('resize', onViewportResize); else window.addEventListener('resize', onViewportResize);
msg.addEventListener('focus', ()=> { setTimeout(()=> { onViewportResize(); scrollChatToBottom(false); }, 60); });
msg.addEventListener('blur', ()=> { setTimeout(()=> onViewportResize(), 60); });

/* rooms refresh and live list */
async function refreshRoomsEvery(interval=30000){ await loadRooms(); setTimeout(()=>refreshRoomsEvery(interval), interval); }
refreshRoomsEvery();
onSnapshot(collection(db,'rooms'), snap=>{ roomList.innerHTML=''; roomListSidebar.innerHTML=''; roomListMobile.innerHTML=''; snap.forEach(d=> renderRoomEntry(d.id)); });

/* utilities */
function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }
function linkify(text){ const urlRe = /((https?:\/\/|www\.)[\w\-@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([\w\-@:%_\+.~#?&//=]*))/gi; return text.replace(urlRe, function(match){ let url = match; if(!/^https?:\/\//i.test(url)) url = 'https://' + url; return `<a href="${url}" target="_blank" rel="noopener">${match}</a>`; }); }
function scrollChatToBottom(instant = true){ try{ if(instant) chat.scrollTop = chat.scrollHeight; else chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' }); updateScrollBtnVisibility(); }catch(e){} }
function updateScrollBtnVisibility(){ const atBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 60; if(!atBottom) scrollBottomBtn.style.display='block'; else scrollBottomBtn.style.display='none'; }
chat.addEventListener('scroll', updateScrollBtnVisibility); scrollBottomBtn.addEventListener('click', ()=> scrollChatToBottom(false));

document.addEventListener('visibilitychange', ()=> { if(!document.hidden){} });

/* helper to hide context menu on Escape */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideContextMenu(); });

</script>
</body>
</html>
