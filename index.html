<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Inter',sans-serif; background:#18191a; color:#eee; display:flex; height:100vh; }
#roomsPanel, #chatPanel { padding:10px; }
#roomsPanel { width:220px; background:#242526; display:flex; flex-direction:column; }
#roomsPanel h2{margin:0 0 10px 0;color:#4b9ce2;font-size:1.1rem;}
.room { padding:8px; margin-bottom:5px; border-radius:5px; background:#2a2b2d; cursor:pointer; transition:.2s; }
.room:hover{background:#4b9ce2;color:#000;}
#chatPanel { flex:1; display:flex; flex-direction:column; display:none; }
#chatHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
#chat{flex:1; overflow-y:auto; background:#242526; padding:10px; border-radius:8px; display:flex; flex-direction:column;}
.message{margin-bottom:8px; word-wrap:break-word;}
.message b{color:#4b9ce2;}
input, button{padding:8px;margin-top:5px;border-radius:5px;border:none;width:100%; background:#2a2b2d; color:#eee;}
button{background:#4b9ce2; font-weight:600; cursor:pointer; transition:.2s;}
button:hover{background:#3a8ad1;}
#msg{margin-top:10px;}
</style>
</head>
<body>

<div id="roomsPanel">
  <h2>Rooms</h2>
  <div id="roomList"></div>
  <input id="nick" placeholder="Your nickname">
  <input id="pass" type="password" placeholder="Room password">
  <button id="joinBtn">Join Room</button>
</div>

<div id="chatPanel">
  <div id="chatHeader">
    <h1 id="chatTitle">Room</h1>
    <button id="backBtn">Return</button>
  </div>
  <div id="chat"></div>
  <input id="msg" placeholder="Type a message (Enter = send)">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  authDomain:"chat-fc8ef.firebaseapp.com",
  projectId:"chat-fc8ef",
  storageBucket:"chat-fc8ef.appspot.com",
  messagingSenderId:"446356718094",
  appId:"1:446356718094:web:f56514352845d6bbb7b25f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let unsub=null;
let nick = localStorage.getItem("nick")||"";

const chat = document.getElementById("chat");
const roomList = document.getElementById("roomList");
const nickInput = document.getElementById("nick");
const passInput = document.getElementById("pass");
const chatPanel = document.getElementById("chatPanel");
const roomsPanel = document.getElementById("roomsPanel");
const chatTitle = document.getElementById("chatTitle");
const msgInput = document.getElementById("msg");

// Load nickname
if(nick) nickInput.value = nick;

// ENTER send
msgInput.addEventListener("keydown", e=>{if(e.key==="Enter") send();});
nickInput.addEventListener("keydown", e=>{if(e.key==="Enter") joinRoom();});
passInput.addEventListener("keydown", e=>{if(e.key==="Enter") joinRoom();});

// Load rooms
async function loadRooms(){
  roomList.innerHTML="";
  const roomsSnap = await getDocs(collection(db,"rooms"));
  roomsSnap.forEach(r=>{
    const div = document.createElement("div");
    div.className="room";
    div.innerText = r.id;
    div.onclick=()=>{
      currentRoom = r.id;
      passInput.focus();
    };
    roomList.appendChild(div);
  });
}
loadRooms();

// Join/create room
async function joinRoom(){
  let room = currentRoom;
  const pass = passInput.value.trim();
  nick = nickInput.value.trim() || "Anon";
  if(!nick){alert("Enter a nickname"); return;}
  if(!room){alert("Select a room"); return;}
  if(!pass){alert("Enter password"); return;}
  localStorage.setItem("nick", nick);

  const roomRef = doc(db,"rooms",room);
  const snap = await getDoc(roomRef);
  const now=Date.now();
  const day=24*60*60*1000;

  if(!snap.exists()){
    await setDoc(roomRef,{password:pass, roomExpiresAt:new Date(now+day)});
  } else {
    if(snap.data().password!==pass){alert("Wrong password"); return;}
    await setDoc(roomRef,{roomExpiresAt:new Date(now+day)},{merge:true});
  }

  // Switch view
  roomsPanel.style.display="none";
  chatPanel.style.display="flex";
  chatTitle.innerText = `ðŸ”¥ ${room}`;

  const q = query(collection(db,"rooms",room,"messages"),orderBy("time"));
  unsub = onSnapshot(q,snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m = d.data();
      chat.innerHTML+=`<div class="message"><b>${m.name}:</b> ${m.text}</div>`;
    });
    chat.scrollTop = chat.scrollHeight;
  });
}

// Send messages
async function send(){
  const text = msgInput.value.trim();
  if(!text) return;

  if(text==="/clear"){
    if(!confirm("Clear all messages in this room?")) return;
    const msgs = await getDocs(collection(db,"rooms",currentRoom,"messages"));
    msgs.forEach(d=>deleteDoc(d.ref));
    msgInput.value=""; return;
  }
  if(text==="/delete"){
    if(!confirm("DELETE ENTIRE ROOM?")) return;
    const msgs = await getDocs(collection(db,"rooms",currentRoom,"messages"));
    msgs.forEach(d=>deleteDoc(d.ref));
    await deleteDoc(doc(db,"rooms",currentRoom));
    returnToRoomList();
    return;
  }

  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    name:nick,
    text,
    time:serverTimestamp(),
    expiresAt:new Date(Date.now()+24*60*60*1000)
  });

  msgInput.value="";
}

// Return to rooms
function returnToRoomList(){
  if(unsub) unsub();
  currentRoom="";
  chat.innerHTML="";
  chatPanel.style.display="none";
  roomsPanel.style.display="flex";
  passInput.value="";
  loadRooms();
}

document.getElementById("joinBtn").addEventListener("click",joinRoom);
document.getElementById("backBtn").addEventListener("click",returnToRoomList);

</script>
</body>
</html>
