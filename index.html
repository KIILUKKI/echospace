<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  height: 100vh;
  font-family: Inter, sans-serif;
  background: #0b0f14;
  color: #e6edf3;
}
#app {
  width: 100%;
  height: 100%;
  position: relative;
}

/* HOME */
#home {
  position: absolute;
  inset: 0;
  display: flex;
  background: #0b0f14;
}
#homeLeft {
  width: 260px;
  height: 100%;
  background: #161b22;
  padding: 14px;
  overflow-y: auto;
  border-right: 1px solid #0d1117;
}
#homeLeft h2 {
  margin: 0 0 14px 0;
  font-weight: 600;
}
.room {
  padding: 10px 12px;
  border-radius: 8px;
  background: #21262d;
  margin-bottom: 8px;
  cursor: pointer;
  transition: .15s;
}
.room:hover {
  background: #58a6ff;
  color: #000;
}
#homeCenter {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
#nickRow {
  display: flex;
  gap: 12px;
  width: 320px;
  margin-bottom: 20px;
}
#nick {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: #21262d;
  color: #fff;
}
#nickColor {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
}
#createRoom {
  padding: 14px 28px;
  border-radius: 12px;
  background: #58a6ff;
  color: #000;
  border: none;
  font-weight: 600;
  cursor: pointer;
}
#createRoom:hover { background:#3f83d0; }

/* MAIN CHAT */
#main {
  display: none;
  height: 100%;
  flex-direction: column;
}
#header {
  height: 52px;
  background: #161b22;
  display: flex;
  align-items: center;
  padding: 0 14px;
  border-bottom: 1px solid #0d1117;
}
#header button {
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
  margin-right: 10px;
}
#chatWrapper {
  display: flex;
  flex: 1;
  overflow: hidden;
}
#chatSidebar {
  width: 260px;
  background: #161b22;
  border-right: 1px solid #0d1117;
}
#chatWrapperMain {
  flex: 1;
  display: flex;
  flex-direction: column;
}
#chat {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.message { display: flex; gap: 10px; }
.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #000;
}
.msg {
  background: #161b22;
  padding: 10px 14px;
  border-radius: 10px;
  width: 100%;
  position: relative;
}
.time { font-size: 11px; color: #8b949e; margin-left: 6px; }
.reply-btn {
  position: absolute;
  right: 8px;
  top: 8px;
  font-size: 12px;
  color: #8b949e;
  cursor: pointer;
  opacity: 0;
}
.msg:hover .reply-btn { opacity: 1; }
.reply-preview {
  background: #0d1117;
  border-left: 3px solid #58a6ff;
  padding: 6px;
  font-size: 12px;
  margin-bottom: 6px;
}
#replyBox {
  display: none;
  background: #21262d;
  padding: 8px 14px;
  font-size: 12px;
}
#inputBar {
  padding: 14px;
  background: #161b22;
  border-top: 1px solid #0d1117;
  display: flex;
  gap: 8px;
  position: relative;
}
#msg {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  border: none;
  background: #0d1117;
  color: #fff;
}
#emojiPicker {
  display: none;
  flex-wrap: wrap;
  gap: 4px;
  padding: 6px;
  background: #21262d;
  border-radius: 8px;
  position: absolute;
  bottom: 60px;
  left: 14px;
}
#emojiPicker div { cursor:pointer; font-size:18px; }
#emojiBtn {
  border:none;
  background:#161b22;
  color:#fff;
  font-size:18px;
  cursor:pointer;
}
#typingIndicator {
  font-size: 12px;
  color: #8b949e;
  margin-left: 16px;
}
</style>
</head>

<body>
<div id="app">

<div id="home">
  <div id="homeLeft">
    <h2>Rooms</h2>
    <div id="roomList"></div>
  </div>
  <div id="homeCenter">
    <div id="nickRow">
      <input id="nick" placeholder="Username">
      <input type="color" id="nickColor" value="#58a6ff">
    </div>
    <button id="createRoom">Create / Join Room</button>
  </div>
</div>

<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName"></span>
  </div>

  <div id="chatWrapper">
    <div id="chatSidebar"></div>
    <div id="chatWrapperMain">
      <div id="chat"></div>
      <div id="typingIndicator"></div>
    </div>
  </div>

  <div id="replyBox"></div>
  <div id="inputBar">
    <input id="msg" placeholder="Message... (/clear /delete)">
    <button id="emojiBtn">üòä</button>
    <div id="emojiPicker"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId: "chat-fc8ef"
});
const db = getFirestore(app);

const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const roomList = document.getElementById("roomList");
const roomName = document.getElementById("roomName");
const emojiPicker = document.getElementById("emojiPicker");
const nickInput = document.getElementById("nick");
const nickColorInput = document.getElementById("nickColor");

let room="", nick="", nickColor="#58a6ff", replyTo=null;

/* load nick */
nickInput.value = localStorage.getItem("nick") || "";
nickColorInput.value = localStorage.getItem("nickColor") || "#58a6ff";
nickColorInput.oninput = () =>
  localStorage.setItem("nickColor", nickColorInput.value);

/* rooms */
async function loadRooms(){
  roomList.innerHTML="";
  const snap = await getDocs(collection(db,"rooms"));
  snap.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.textContent="# "+r.id;
    d.onclick=()=>joinRoom(r.id);
    roomList.appendChild(d);
  });
}

/* create/join */
createRoom.onclick = async ()=>{
  const r = prompt("Room name"); if(!r) return;
  const p = prompt("Password (optional)");
  const ref = doc(db,"rooms",r);
  if(!(await getDoc(ref)).exists())
    await setDoc(ref,{password:p||"",created:serverTimestamp()});
  joinRoom(r);
};

async function joinRoom(r){
  const ref = doc(db,"rooms",r);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert("Room doesn't exist");

  const pass = prompt("Password");
  if(pass!==snap.data().password) return alert("Wrong password");

  nick = nickInput.value || ("Anon"+Math.floor(Math.random()*1000));
  nickColor = nickColorInput.value;
  localStorage.setItem("nick",nick);
  localStorage.setItem("nickColor",nickColor);

  home.style.display="none";
  main.style.display="flex";
  room=r;
  roomName.textContent="# "+r;

  onSnapshot(
    query(collection(db,"rooms",room,"messages"),orderBy("time")),
    snap=>{
      chat.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const t=m.time?.toDate();
        chat.innerHTML+=`
          <div class="message">
            <div class="avatar" style="background:${m.color}">${m.name[0]}</div>
            <div class="msg">
              <b style="color:${m.color}">${m.name}</b>
              <span class="time">${t?t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):""}</span>
              <div>${m.text}</div>
            </div>
          </div>`;
      });
      chat.scrollTop=chat.scrollHeight;
    }
  );
}

/* send */
msg.addEventListener("keydown", async e=>{
  if(e.key!=="Enter") return;
  const text=msg.value.trim();
  msg.value="";
  if(!text) return;

  if(text==="/clear"){
    const msgs=await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    return;
  }

  await addDoc(collection(db,"rooms",room,"messages"),{
    name:nick,
    text,
    color:nickColor,
    time:serverTimestamp()
  });
});

/* emoji */
["üòÄ","üòÇ","üòé","üòç","üëç","‚ù§Ô∏è","üéâ","ü§î","üî•"].forEach(e=>{
  const d=document.createElement("div");
  d.textContent=e;
  d.onclick=()=>msg.value+=e;
  emojiPicker.appendChild(d);
});
emojiBtn.onclick=()=>emojiPicker.style.display=
  emojiPicker.style.display==="flex"?"none":"flex";

back.onclick=()=>location.reload();

loadRooms();
</script>
</body>
</html>
