<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Mini Chat</title>
<style>
body { background:#111; color:#eee; font-family:sans-serif }
#chat { height:300px; overflow:auto; border:1px solid #444; padding:5px }
input, button { width:100%; margin-top:5px; padding:6px }
.hidden { display:none }
</style>
</head>
<body>

<h2 id="title">ðŸ”¥ Mini Chat</h2>

<div id="login">
  <input id="room" placeholder="Huoneen nimi">
  <input id="pass" type="password" placeholder="Salasana">
  <button onclick="join()">Liity / Luo huone</button>
</div>

<div id="chatUI" class="hidden">
  <div id="chat"></div>
  <input id="name" placeholder="Nimi">
  <input id="msg" placeholder="Viesti (Enter = lÃ¤hetÃ¤)">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  authDomain: "chat-fc8ef.firebaseapp.com",
  projectId: "chat-fc8ef",
  storageBucket: "chat-fc8ef.appspot.com",
  messagingSenderId: "446356718094",
  appId: "1:446356718094:web:f56514352845d6bbb7b25f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let unsub = null;

const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");

// ENTER = lÃ¤hetÃ¤
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter") send();
});

window.join = async () => {
  const room = document.getElementById("room").value.trim();
  const pass = document.getElementById("pass").value;

  if (!room || !pass) {
    alert("Anna huone ja salasana");
    return;
  }

  const roomRef = doc(db, "rooms", room);
  const snap = await getDoc(roomRef);

  const now = Date.now();
  const day = 24 * 60 * 60 * 1000;

  if (!snap.exists()) {
    // ðŸ”¥ LUO HUONE
    await setDoc(roomRef, {
      password: pass,
      roomExpiresAt: new Date(now + day)
    });
  } else {
    if (snap.data().password !== pass) {
      alert("VÃ¤Ã¤rÃ¤ salasana");
      return;
    }
    // ðŸ”„ PÃ¤ivitÃ¤ huoneen elinikÃ¤Ã¤ kun joku liittyy
    await setDoc(roomRef, {
      roomExpiresAt: new Date(now + day)
    }, { merge: true });
  }

  currentRoom = room;
  document.getElementById("login").classList.add("hidden");
  document.getElementById("chatUI").classList.remove("hidden");
  document.getElementById("title").innerText = "ðŸ”¥ Huone: " + room;

  const q = query(
    collection(db, "rooms", room, "messages"),
    orderBy("time")
  );

  unsub = onSnapshot(q, snap => {
    chat.innerHTML = "";
    snap.forEach(d => {
      const m = d.data();
      chat.innerHTML += `<div><b>${m.name}:</b> ${m.text}</div>`;
    });
    chat.scrollTop = chat.scrollHeight;
  });
};

window.send = async () => {
  const name = document.getElementById("name").value || "Anon";
  const text = msgInput.value.trim();
  if (!text) return;

  // ðŸ”§ KOMENNOT
  if (text === "/clear") {
    if (!confirm("TyhjennetÃ¤Ã¤nkÃ¶ huone?")) return;
    const msgs = await getDocs(collection(db, "rooms", currentRoom, "messages"));
    msgs.forEach(d => deleteDoc(d.ref));
    msgInput.value = "";
    return;
  }

  if (text === "/delete") {
    if (!confirm("POISTETAAN KOKO HUONE?")) return;

    const msgs = await getDocs(collection(db, "rooms", currentRoom, "messages"));
    msgs.forEach(d => deleteDoc(d.ref));

    await deleteDoc(doc(db, "rooms", currentRoom));
    location.reload();
    return;
  }

  // ðŸ’¬ NORMAALI VIESTI
  await addDoc(
    collection(db, "rooms", currentRoom, "messages"),
    {
      name,
      text,
      time: serverTimestamp(),
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
    }
  );

  msgInput.value = "";
};
</script>

</body>
</html>
