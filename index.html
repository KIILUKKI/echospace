<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MiniChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;font-family:Inter,sans-serif;background:#0b0f14;color:#e6edf3}
#app{width:100%;height:100%;position:relative;display:flex;flex-direction:column}

/* LOGIN */
#login{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;background:#0b0f14;flex-direction:column}
#login input{padding:12px;margin:6px;border-radius:8px;border:none;background:#21262d;color:#fff;width:200px}
#login button{padding:12px 24px;margin-top:12px;border:none;border-radius:10px;background:#58a6ff;color:#000;font-weight:600;cursor:pointer}

/* HOME */
#home{display:none;flex:1;flex-direction:column;position:relative}
#homeTop{display:flex;align-items:center;gap:12px;padding:14px}
#nickDisplay{flex:1;padding:10px;border-radius:8px;background:#21262d;color:#fff;display:flex;align-items:center;justify-content:space-between}
#nickColor{width:32px;height:32px;border-radius:50%;border:none;cursor:pointer}
#createRoom{padding:10px 16px;border-radius:10px;background:#58a6ff;color:#000;border:none;font-weight:600;cursor:pointer;margin-left:12px}

#homeLeft{width:260px;height:100%;background:#161b22;padding:14px;overflow-y:auto;border-right:1px solid #0d1117;position:absolute;top:0;bottom:0;left:0}
#homeLeft h2{margin:0 0 14px}
.room{padding:10px 12px;border-radius:8px;background:#21262d;margin-bottom:8px;cursor:pointer}
.room:hover{background:#58a6ff;color:#000}

/* MAIN */
#main{display:none;height:100%;flex-direction:column}
#header{height:52px;background:#161b22;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid #0d1117}
#header button{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;margin-right:10px}
#chatWrapper{display:flex;flex:1;overflow:hidden}
#chatSidebar{width:260px;background:#161b22;border-right:1px solid #0d1117}
#chatWrapperMain{flex:1;display:flex;flex-direction:column}
#chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}

/* messages */
.message{display:flex;gap:10px}
.avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:#000}
.msg{background:#161b22;padding:10px 14px;border-radius:10px;width:100%;position:relative}
.time{font-size:11px;color:#8b949e;margin-left:6px}
.reply-btn{position:absolute;right:8px;top:8px;font-size:12px;color:#8b949e;cursor:pointer;opacity:0}
.msg:hover .reply-btn{opacity:1}
.reply-preview{background:#0d1117;border-left:3px solid #58a6ff;padding:6px;font-size:12px;margin-bottom:6px}

/* input */
#replyBox{display:none;background:#21262d;padding:8px 14px;font-size:12px;color:#fff}
#replyBox span{color:#58a6ff}
#inputBar{padding:14px;background:#161b22;border-top:1px solid #0d1117;display:flex;gap:8px;position:relative;align-items:center}
#msg{flex:1;padding:12px;border-radius:8px;border:none;background:#0d1117;color:#fff}

/* emoji */
#emojiPicker{display:none;flex-wrap:wrap;gap:4px;padding:6px;background:#21262d;border-radius:8px;position:absolute;bottom:60px;left:14px;max-width:320px;max-height:200px;overflow-y:auto}
#emojiPicker div{cursor:pointer;font-size:18px}
#emojiBtn{border:none;background:#161b22;color:#fff;font-size:18px;cursor:pointer}

/* typing */
#typingIndicator{font-size:12px;color:#8b949e;margin-left:16px}
</style>
</head>
<body>
<div id="app">

<!-- LOGIN -->
<div id="login">
  <input id="loginNick" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Password">
  <button id="loginBtn">Login / Register</button>
</div>

<!-- HOME / Lobby -->
<div id="home">
  <div id="homeTop">
    <div id="nickDisplay">
      <span id="homeNick"></span>
      <input type="color" id="nickColor" value="#58a6ff">
    </div>
    <button id="createRoom">Create / Join Room</button>
  </div>
  <div id="homeLeft">
    <h2>Rooms</h2>
    <div id="roomList"></div>
  </div>
</div>

<!-- MAIN / Chat -->
<div id="main">
  <div id="header">
    <button id="back">‚Üê</button>
    <span id="roomName"></span>
  </div>

  <div id="chatWrapper">
    <div id="chatSidebar"></div>
    <div id="chatWrapperMain">
      <div id="chat"></div>
      <div id="typingIndicator"></div>
    </div>
  </div>

  <div id="replyBox"></div>
  <div id="inputBar">
    <button id="emojiBtn">üòä</button>
    <input id="msg" placeholder="Message... (/clear /delete)">
    <div id="emojiPicker"></div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, collection,
  addDoc, getDocs, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDbYLUXJjHQ-V5uFvtyzwq-IwIKM7xTcyc",
  projectId:"chat-fc8ef"
});
const db = getFirestore(app);

/* DOM */
const loginDiv = document.getElementById("login");
const loginNick = document.getElementById("loginNick");
const loginPass = document.getElementById("loginPass");
const loginBtn = document.getElementById("loginBtn");

const home = document.getElementById("home");
const homeNick = document.getElementById("homeNick");
const nickColorInput = document.getElementById("nickColor");
const createRoomBtn = document.getElementById("createRoom");
const roomList = document.getElementById("roomList");

const main = document.getElementById("main");
const roomName = document.getElementById("roomName");
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const replyBox = document.getElementById("replyBox");
const emojiPicker = document.getElementById("emojiPicker");
const emojiBtn = document.getElementById("emojiBtn");
const typingIndicator = document.getElementById("typingIndicator");

let nick="", nickColor="#58a6ff", room="", replyTo=null, lastMessageTime=0, typingTimeout=null;

/* notifications */
if(Notification.permission!=="granted") Notification.requestPermission();

/* local login/register */
loginBtn.onclick = async ()=>{
  const n = loginNick.value.trim();
  const p = loginPass.value.trim();
  if(!n || !p) return alert("Enter username and password");

  const uRef = doc(db,"users",n);
  const snap = await getDoc(uRef);
  if(snap.exists()){
    if(snap.data().pass!==p) return alert("Wrong password");
  } else {
    await setDoc(uRef,{pass:p,color:"#58a6ff"});
  }

  nick = n;
  nickColor = snap.exists()?snap.data().color:"#58a6ff";
  loginDiv.style.display="none";
  home.style.display="flex";
  homeNick.textContent = nick;
  nickColorInput.value = nickColor;
  localStorage.setItem("nick",nick);
  localStorage.setItem("nickColor",nickColor);

  loadRooms();
};

/* change color in lobby */
nickColorInput.oninput = ()=>{
  nickColor = nickColorInput.value;
  localStorage.setItem("nickColor",nickColor);
};

/* load rooms */
async function loadRooms(){
  roomList.innerHTML="";
  const s = await getDocs(collection(db,"rooms"));
  s.forEach(r=>{
    const d = document.createElement("div");
    d.className = "room";
    d.textContent = "# "+r.id;
    d.onclick = ()=>joinRoomPrompt(r.id);
    roomList.appendChild(d);
  });
}

/* join/create room */
createRoomBtn.onclick = async ()=>{
  if(!nick) return alert("Login first!");
  const r = prompt("Room name"); if(!r) return;
  joinRoomPrompt(r);
};

async function joinRoomPrompt(r){
  const ref = doc(db,"rooms",r);
  const snap = await getDoc(ref);
  let p = "";
  if(snap.exists()) p = prompt("Password for "+r);
  if(snap.exists() && snap.data().password!==p) return alert("Wrong password");

  if(!snap.exists()){
    const np = prompt("Set password for new room");
    if(!np) return alert("Password required");
    await setDoc(ref,{password:np,created:serverTimestamp()});
  }

  joinRoom(r);
}

async function joinRoom(r){
  room = r;
  home.style.display="none";
  main.style.display="flex";
  roomName.textContent = "# "+r;

  /* messages */
  onSnapshot(query(collection(db,"rooms",room,"messages"),orderBy("time")),snap=>{
    chat.innerHTML="";
    const now = Date.now();
    snap.forEach(d=>{
      const m = d.data();
      const t = m.time?.toMillis()||0;
      if(t>lastMessageTime && document.hidden && m.name!==nick){
        new Notification("New message.");
      }
      lastMessageTime = Math.max(lastMessageTime,t);

      const el = document.createElement("div");
      el.className="message";
      el.innerHTML=`
        <div class="avatar" style="background:${m.color}">${m.name[0]}</div>
        <div class="msg">
          ${m.reply?`<div class="reply-preview"><b>${m.reply.name}</b>: ${m.reply.text}</div>`:""}
          <b style="color:${m.color}">${m.name}</b>
          <span class="time">${t?new Date(t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):""}</span>
          <div>${m.text}</div>
          <div class="reply-btn" data-name="${m.name}" data-text="${m.text}">reply</div>
        </div>`;
      chat.appendChild(el);
    });
    chat.scrollTop=chat.scrollHeight;
  });

  /* typing */
  onSnapshot(collection(db,"rooms",room,"typing"),snap=>{
    const now = Date.now();
    const users = [];
    snap.forEach(d=>{
      if(d.id===nick) return;
      if(d.data().t && now-d.data().t<2000) users.push(d.id);
    });
    typingIndicator.textContent = users.length ? users.join(", ")+" typing..." : "";
  });
}

/* typing write */
msg.addEventListener("input",()=>{
  if(!room||!nick) return;
  if(msg.value.trim()===""){
    deleteDoc(doc(db,"rooms",room,"typing",nick));
    return;
  }
  setDoc(doc(db,"rooms",room,"typing",nick),{t:Date.now()});
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{deleteDoc(doc(db,"rooms",room,"typing",nick))},2000);
});
msg.addEventListener("blur",()=>{if(room&&nick) deleteDoc(doc(db,"rooms",room,"typing",nick));});

/* reply */
chat.onclick = e=>{
  const b = e.target.closest(".reply-btn");
  if(!b) return;
  replyTo={name:b.dataset.name,text:b.dataset.text};
  replyBox.style.display="block";
  replyBox.innerHTML=`Replying to <span>${replyTo.name}</span><button onclick="cancelReply()">x</button>`;
};
window.cancelReply = ()=>{replyTo=null; replyBox.style.display="none";};

/* send messages */
msg.addEventListener("keydown", async e=>{
  if(e.key!=="Enter") return;
  const text = msg.value.trim();
  msg.value="";
  if(!text) return;
  if(!room){ alert("Join a room first!"); return; }
  deleteDoc(doc(db,"rooms",room,"typing",nick));

  if(text==="/clear"){
    const msgs = await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    return;
  }
  if(text==="/delete"){
    if(!confirm("Delete entire room?")) return;
    const msgs = await getDocs(collection(db,"rooms",room,"messages"));
    for(const d of msgs.docs) await deleteDoc(d.ref);
    await deleteDoc(doc(db,"rooms",room));
    location.reload();
    return;
  }

  await addDoc(collection(db,"rooms",room,"messages"),{
    name:nick,text,reply:replyTo,color:nickColor,time:serverTimestamp()
  });
  replyTo=null;
  replyBox.style.display="none";
});

/* emojis */
[
  "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÇ","ü§£","üôÇ","üôÉ","üòâ","üòä","üòá",
  "üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòú","ü§™","üòù",
  "ü§ó","ü§≠","ü§´","ü§î","ü§®","üòê","üòë","üò∂","üôÑ","üòè",
  "üò£","üò•","üòÆ","üòØ","üò≤","üò™","üò´","ü•±","üò¥","üòå",
  "üò§","üò†","üò°","ü§¨","üò¢","üò≠","ü•∫","üò≥","üò±","üò®","üò∞","üòì",
  "üëç","üëé","üëå","ü§å","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëã","üëè","üôå","üôè",
  "‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","üíï","üíû","üíì","üíó","üíñ",
  "üî•","üíØ","‚ú®","‚≠ê","üåü","‚ö°","üéâ","üéä","üéà","üé∂","üéµ",
  "üòé","ü§ì","üßê","üëÄ","üß†","ü§°","üëª","üëΩ","ü§ñ","üíÄ","üí©","ü´∂"
].forEach(e=>{
  const d = document.createElement("div");
  d.textContent=e;
  d.onclick=()=>msg.value+=e;
  emojiPicker.appendChild(d);
});
emojiBtn.onclick=()=>emojiPicker.style.display=emojiPicker.style.display==="flex"?"none":"flex";
msg.onfocus=()=>emojiPicker.style.display="none";

document.getElementById("back").onclick=()=>location.reload();
</script>
</body>
</html>
